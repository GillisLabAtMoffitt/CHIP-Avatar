---
title: "Drugs Report"
author: "Christelle Colin-Leitzinger"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_collapsed: no
    theme: cerulean
    highlight: pygments
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{=html}
<style type="text/css">
h1.title {
  font-size: 25px;
}
.figure {
   margin-top: 25px;
   margin-bottom: 100px;
}

table {
    margin-top: 25px;
    margin-bottom: 25px;
}
</style>
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")

```

```{=html}
<style>
div.blue { background-color:#0099CC; border-radius: 5px; padding: 20px; font-size: 38px}
</style>
```
::: {.blue}
[Drugs]{style="color: white;"}
:::

<br>

```{r library, include=FALSE}
library(tidyverse)
library(data.table)
library(VennDiagram)
library(viridis)
library(lubridate)
library(gtsummary)
library(survival)
library(survminer)
```

```{r load}
# Global_data <- readRDS("/Users/colinccm/Documents/GitHub/CHIP-Avatar/Global_data.rds")
germline_patient_data <- readRDS("/Users/colinccm/Documents/GitHub/CHIP-Avatar/germline_patient_data.rds")
# Treatment1 <-  readRDS("/Users/colinccm/Documents/GitHub/CHIP-Avatar/Treatment1.rds")
# path <- fs::path("","Volumes","Gillis_Research","Christelle Colin-Leitzinger", "CHIP in Avatar")
# patients_removed_nonMM <- c("A000428", "A000456")
```


***

# MM patients with WES who received Drugs
<br> 
<br>

***

## 1. Demographics

```{r data}
germline_patient_data <- germline_patient_data %>% 
  distinct(avatar_id, .keep_all = TRUE) %>% 
  filter(!is.na(date_of_MMonly_diagnosis))

drugs_data <- germline_patient_data %>% 
  filter(!is.na(line_start_date_1))
```

Within the active multiple myeloma patient in the MM avatar data (N=`r germline_patient_data %>% NROW()`), `r drugs_data %>% NROW()` received drugs.  
```{r demographics in germline}
drugs_data %>% 
  mutate(Whole = "Drugs patients") %>% 
  mutate(Race = str_replace(Race, "Unknown", NA_character_)) %>% 
  mutate(Ethnicity = str_replace(Ethnicity, "Unknown", NA_character_)) %>% 
  select(Age_at_MMonly_diagnosis, 
         Gender, Race, Ethnicity, Whole, ISS, ISS_grp) %>%
  tbl_summary(by = Whole, label = list(Age_at_MMonly_diagnosis ~ "Age at MM diagnosis"),
              sort = list(everything() ~ "frequency", ISS ~ "alphanumeric", ISS_grp ~ "alphanumeric"),
              digits = list(c(Age_at_MMonly_diagnosis) ~ 2),
              missing = "no") %>% 
  bold_labels() %>% as_gt() %>%  
  gt::tab_source_note(gt::md("**Data for active MM patients who received Drugs**")) %>% 
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))
```
<br> 
<br>

***

## 2. Disease Status at Time of Blood Collection (`r emo::ji("warning")` is not at time of Drugs)

```{r}
drugs_data %>%
  mutate(Whole = "Drugs patients") %>% 
  select(Disease_Status_germline, Whole) %>% 
  tbl_summary(by = Whole, 
              label = list(Disease_Status_germline ~ "Disease Status at Time of Blood Collection"),
              sort = list(everything() ~ "frequency")) %>% 
  bold_labels() %>% as_gt()  %>%
  gt::tab_source_note(gt::md("**All these patients are now active MM patients**")) %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

drugs_data %>%
  distinct(avatar_id, .keep_all = TRUE) %>%
  group_by(Disease_Status_germline) %>% count(Disease_Status_germline) %>% 
  mutate(Disease_Status_germline = fct_reorder(as.character(Disease_Status_germline), desc(n))) %>%
  arrange(n) %>% 
  ggplot(aes(x="", y=n, fill=Disease_Status_germline)) +
  geom_bar(stat="identity", width=1) +
  geom_text(aes(label = paste0(n, " %")), size = 5, position = position_stack(vjust = 0.5))+
  scale_fill_manual("", values = c("hotpink", "orchid1", "mediumorchid1", "mediumpurple1", "lemonchiffon", "peachpuff", 
                                                               "lightcyan", "lightblue", "cyan", "steelblue1", "blue", "darkblue")) +
  theme_void(base_size = 16) +
  theme(plot.title = element_text(hjust = -0.15))+
  coord_polar("y", start=0, direction=-1) +
  labs(x=NULL, y=NULL, title="Disease Status at Blood Collection")

# mysurv <- Surv(time = germline_patient_data$month_at_os, event = germline_patient_data$os_event)
# myplot <- survfit(mysurv~Disease_Status_germline, data = germline_patient_data)
# ggsurvplot(myplot, data = germline_patient_data,
#            title = "OS",
#            font.main = c(24, "bold", "black"),
#            font.x = c(20, "bold", "black"),
#            font.y = c(20, "bold", "black"),
#            font.legend = c(20, "bold", "black"),
#            font.tickslab = c(18, "bold", "black"),
#            size = 1.5,
#            
#            xlab = "Time in months", 
#            legend = "top",
#            legend.title = "",
#            # # legend.labs = c("Hipanic", "Non-Hispanic", "Unknown"),
#            # palette = c("darkred", "darkgreen", "grey"),
#            pval = TRUE,
#            conf.int = FALSE,
#            # xlim = c(-10, 150),
# # Add risk table
#            tables.height = 0.3,
#            risk.table.title = "Risk table (number(%))",
#            risk.table = "abs_pct",
#            risk.table.y.text = FALSE,
#            risk.table.fontsize = 4,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")),
#            # Censor
#            censor = TRUE
# ) + guides(colour = guide_legend(nrow = 3), linetype = guide_legend(nrow = 3))
```
<br> 
<br>

***

## 3. Time from blood collection to Drugs

```{r, fig.width=10}
drugs_data %>%
  mutate(Whole = "Drugs patients") %>% 
  select(days_blood_drugs, Whole, time_to_drug) %>% 
  tbl_summary(by = Whole, label = list(days_blood_drugs ~ "Time to Drugs from Blood Collection (in days)", time_to_drug ~ "Time to Drugs from MM diagnosis (in days)")) %>% 
  bold_labels() %>% as_gt() %>%  
  gt::tab_source_note(gt::md("**Drugs happen 625 days before blood collection**")) %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

p <- qplot(x =days_blood_drugs, data=subset(drugs_data,!is.na(days_blood_drugs)), fill=..count.., 
           geom="histogram", 
           binwidth = 100,
           ) 
p + scale_fill_viridis_c(
  alpha = 1,
  begin = 0,
  end = 1,
  direction = 1,
  option = "D",
  values = NULL,
  space = "Lab",
  na.value = "grey50",
  guide = "colourbar",
  aesthetics = "fill"
) +
  xlim(c(-8000,2500))+
  theme_minimal(base_size = 14) +
  labs(x="Time to Drugs from Blood Collection (in days)", y="Number of Patient", title="Number of Days Between Blood Collection and Drugs",
       caption = "Each bar represents 100 days")+
  
  annotate("text", x = -3750, y = 75, # x and y coordinates of the text
           label = "Drugs before \nblood collection", 
           size = 4) +
  annotate("segment", x = -8000, xend = -15, y = 75, yend = 75,
           size = 1, colour = "steelblue")+
  annotate("text", x = 1450, y = 75, # x and y coordinates of the text
           label = "Drugs after \nblood collection", 
           size = 4) +
  annotate("segment", x = 15, xend = 2500, y = 75, yend = 75,
           size = 1, colour = "blue") #+ 
  
  # scale_x_continuous(breaks=c(-7500, -6225, -5000, -3775, -2500, -1225, 0, 200, 1225, 2500),
  #         minor_breaks=c(0, 200)
  #         ) + 
  # theme(axis.text.x = element_text(angle=90, size=c(12, 12, 12, 12, 12, 12, 9, 12, 12)))# +
  # geom_text(stat="count", aes(label=stat(count)), vjust=-0.2) 

drugs_data %>% 
  select(drugs_before_germline) %>% 
  tbl_summary(label = list(drugs_before_germline ~ "Drugs vs germline"),
              sort = list(everything() ~ "frequency"),
              missing = "no") %>% 
  bold_labels() %>% as_gt() %>%  
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

drugs_data %>% 
  mutate(drugs_before_germline = str_replace(drugs_before_germline, "No Drugs", NA_character_)) %>% 
  select(drugs_before_germline, days_blood_drugs, drugs_before_germline) %>% 
  tbl_summary(by = drugs_before_germline, label = list(days_blood_drugs ~ "Time to Drugs from Blood Collection (in days)"),
              sort = list(everything() ~ "frequency"),
              missing = "no") %>% 
  bold_labels() %>% as_gt() %>%  
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

drugs_data %>% 
  mutate(drugs_before_germline = str_replace(drugs_before_germline, "No Drugs", NA_character_)) %>%
  select(drugs_before_germline, Disease_Status_germline) %>% 
  tbl_summary(by = drugs_before_germline, label = list(Disease_Status_germline ~ "Disease Status at Blood collection"),
              sort = list(everything() ~ "frequency"),
              missing = "no") %>% 
  bold_labels() %>% as_gt() %>%  
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

```

<br> 
<br>

***

## 4. Name of first regimen for Drugs patients

The first table include the name of the **FIRST regimen** name.  

```{r}
drugs_data %>% 
  mutate(Whole = "Drugs patients") %>% 
  select(first_regimen_name, Whole) %>% 
  tbl_summary(by = Whole,
              sort = list(everything() ~ "frequency")) %>% 
  bold_labels() %>% as_gt()  %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))
```

In the next table I removed Melphalan in the line number
```{r}
drugs_data %>%
  mutate(across(.cols = starts_with("drug_name_"), ~na_if(., "melphalan"))) %>%
  mutate(line_start_date_1 = case_when(
    is.na(drug_name__1)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_1
  )) %>%
  mutate(line_start_date_2 = case_when(
    is.na(drug_name__2)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_2
  )) %>%
  mutate(line_start_date_3 = case_when(
    is.na(drug_name__3)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_3
  )) %>%
  mutate(line_start_date_4 = case_when(
    is.na(drug_name__4)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_4
  )) %>%
  mutate(line_start_date_5 = case_when(
    is.na(drug_name__5)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_5
  )) %>%
  mutate(line_start_date_6 = case_when(
    is.na(drug_name__6)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_6
  )) %>%
  mutate(line_start_date_7 = case_when(
    is.na(drug_name__7)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_7
  )) %>%
  mutate(line_start_date_8 = case_when(
    is.na(drug_name__8)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_8
  )) %>%
  mutate(line_start_date_9 = case_when(
    is.na(drug_name__9)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_9
  )) %>%

  select(avatar_id, starts_with("line_start")) %>%
  pivot_longer(cols = -c(avatar_id),
               names_to = "line", values_to = "date") %>% 
  filter(!is.na(date)) %>% 
  arrange(avatar_id, date) %>% 
  group_by(avatar_id) %>% 
  mutate(line_bf_drug = n()) %>% 
  ungroup() %>% 
  distinct(avatar_id, .keep_all = TRUE) %>% 
  select(line_bf_drug) %>% 
  mutate(line_bf_drug = case_when(
    line_bf_drug > 4            ~ "more than 4",
    TRUE                        ~ as.character(line_bf_drug)
  )) %>% 
  select(line_bf_drug) %>% 
  tbl_summary(label = list(line_bf_drug ~ "Number of line received"),
              missing_text = "No Drugs") %>% bold_labels() %>% as_gt() %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

drugs_data %>%
  mutate(across(.cols = starts_with("drug_name_"), ~na_if(., "melphalan"))) %>%
  mutate(line_start_date_1 = case_when(
    is.na(drug_name__1)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_1
  )) %>%
  mutate(line_start_date_2 = case_when(
    is.na(drug_name__2)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_2
  )) %>%
  mutate(line_start_date_3 = case_when(
    is.na(drug_name__3)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_3
  )) %>%
  mutate(line_start_date_4 = case_when(
    is.na(drug_name__4)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_4
  )) %>%
  mutate(line_start_date_5 = case_when(
    is.na(drug_name__5)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_5
  )) %>%
  mutate(line_start_date_6 = case_when(
    is.na(drug_name__6)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_6
  )) %>%
  mutate(line_start_date_7 = case_when(
    is.na(drug_name__7)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_7
  )) %>%
  mutate(line_start_date_8 = case_when(
    is.na(drug_name__8)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_8
  )) %>%
  mutate(line_start_date_9 = case_when(
    is.na(drug_name__9)           ~ NA_POSIXct_,
    TRUE                          ~ line_start_date_9
  )) %>%

  select(avatar_id, collectiondt_germline, starts_with("line_start")) %>%
  pivot_longer(cols = -c(avatar_id, collectiondt_germline),
               names_to = "line", values_to = "date") %>% 
  filter(date < collectiondt_germline , !is.na(date)) %>% 
  arrange(avatar_id, date) %>% 
  group_by(avatar_id) %>% 
  mutate(line_bf_drug = n()) %>% 
  ungroup() %>% 
  distinct(avatar_id, .keep_all = TRUE) %>% 
  select(line_bf_drug) %>% 
  mutate(line_bf_drug = case_when(
    line_bf_drug > 4         ~ "more than 4",
    TRUE                        ~ as.character(line_bf_drug)
  )) %>% 
  select(line_bf_drug) %>% 
  tbl_summary(label = list(line_bf_drug ~ "Number of line of drugs received by patients before Blood"),
              missing_text = "No Drugs") %>% bold_labels() %>% as_gt() %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))
```
<br> 
<br>

***

## 6. CH

CH status is assessed by using the Avatar WES data.

```{r}
drugs_data %>%
  distinct(avatar_id, .keep_all = TRUE) %>% 
  select(CH_status) %>% 
  tbl_summary(sort = list(everything() ~ "frequency")) %>% 
  bold_labels() %>% as_gt() %>%  
  gt::tab_style(
    style = gt::cell_text(
      color = "#0099CC"
    ),
    locations = gt::cells_column_labels(everything())
  ) 

tbl1 <- drugs_data %>% 
  mutate(Race = str_replace(Race, "Unknown", NA_character_)) %>% 
  mutate(Ethnicity = str_replace(Ethnicity, "Unknown", NA_character_)) %>% 
  select(Age_at_MMonly_diagnosis, 
         Gender, Race, Ethnicity, ISS, ISS_grp, CH_status) %>%
  tbl_summary(by = CH_status, label = list(Age_at_MMonly_diagnosis ~ "Age at MM diagnosis"),
              sort = list(everything() ~ "frequency", ISS ~ "alphanumeric"),
              digits = list(c(Age_at_MMonly_diagnosis) ~ 2),
              missing = "no") %>% 
  bold_labels() %>% add_p(correct = FALSE) %>% bold_p(t = .05)# %>% as_gt() %>%  
  # gt::tab_source_note(gt::md("**Data for active MM patients who received Drugs**")) %>% 
  # gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

tbl2 <- drugs_data %>%
  select(avatar_id, collectiondt_germline, starts_with("line_start"), CH_status) %>% 
  pivot_longer(cols = starts_with("line_start"),
               names_to = "line", values_to = "date", values_drop_na = TRUE) %>% 
  filter(date < collectiondt_germline) %>% 
  group_by(avatar_id) %>% 
  mutate(line_bf_blood = n()) %>% 
  ungroup() %>% 
  distinct(avatar_id, .keep_all = TRUE) %>%
  mutate(line_bf_blood = ifelse(line_bf_blood > 4, "greater than 4", as.character(line_bf_blood))) %>% 
  mutate(line_bf_blood = factor(line_bf_blood)) %>% 
  select(line_bf_blood, CH_status) %>% 
  tbl_summary(by = CH_status,
              label = list(line_bf_blood ~ "Number of line of drugs received by patients before blood collection"),
              missing_text = "No Drugs") %>% 
  
  # modify_spanning_header(everything() ~ "Number of line of drugs received by patients before blood collection") %>% 
  bold_labels() %>% add_p(correct = FALSE) %>% bold_p(t = .05) #%>% as_gt() %>% 
  # gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

tbl_stack(list(tbl1, tbl2)) %>% as_gt() %>%
  gt::tab_source_note(gt::md("**Data for active MM patients who received Drugs**")) %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

# drugs_data %>% filter(Disease_Status_germline == "Pre Treatment Newly Diagnosed Multiple Myeloma") %>% 
#   mutate(Disease_Status_germline = as.character(Disease_Status_germline)) %>% 
#   select(Disease_Status_germline, CH_status) %>% 
#   tbl_summary(by = Disease_Status_germline,
#               label = list(CH_status ~ "CH_status")) %>% 
#     bold_labels() 
# drugs_data %>% filter(Disease_Status_germline == "Late Relapse Multiple Myeloma") %>% 
#   mutate(Disease_Status_germline = as.character(Disease_Status_germline)) %>% 
#   select(Disease_Status_germline, CH_status) %>% 
#   tbl_summary(by = Disease_Status_germline,
#               label = list(CH_status ~ "CH_status")) %>% 
#     bold_labels() 
```


```{r}
# drugs_data %>%
#   select(avatar_id, starts_with("treatment_line_"), CH_status) %>% 
#   pivot_longer(cols = starts_with("treatment_line_"),
#                names_to = "regimen_number", values_to = "treatment_line_", values_drop_na = TRUE) %>% 
#   filter(treatment_line_ < 90) %>% 
#   arrange(desc(treatment_line_)) %>% 
#   distinct(avatar_id, .keep_all = TRUE) %>% 
#   mutate(treatment_line_ = case_when(
#     as.numeric(treatment_line_) > 5         ~ "more than 5",
#     TRUE                                    ~ as.character(treatment_line_)
#   )) %>% 
#   select(treatment_line_, CH_status) %>% 
#   tbl_summary(by = treatment_line_,
#               missing_text = "No Drugs") %>%
#   modify_spanning_header(everything() ~ "Number of line received by Drugs patients") %>% 
#   bold_labels() %>% add_p(correct = FALSE) %>% bold_p(t = .05) %>% as_gt() %>% 
#   gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))
# 
# drugs_data %>%
#   select(avatar_id, date_of_bmt_1, starts_with("line_start"), CH_status) %>% 
#   pivot_longer(cols = starts_with("line_start"),
#                names_to = "line", values_to = "date", values_drop_na = TRUE) %>% 
#   filter(date < date_of_bmt_1) %>% 
#   group_by(avatar_id) %>% 
#   mutate(line_bf_Drugs = n()) %>% 
#   ungroup() %>% 
#   distinct(avatar_id, .keep_all = TRUE) %>% 
#   select(line_bf_Drugs, CH_status) %>% 
#   tbl_summary(by = line_bf_Drugs,
#               missing_text = "No Drugs") %>% 
#   modify_spanning_header(everything() ~ "Number of line of drugs received by patients before Drugs") %>% 
#   bold_labels() %>% add_p(correct = FALSE) %>% bold_p(t = .05) %>% as_gt() %>% 
#   gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))


```

```{r}
# drugs_data %>% 
#   distinct(avatar_id, .keep_all = TRUE) %>% 
#   # mutate(Whole = "Germline patients") %>% 
#   select(ISS, ISS_grp CH_status) %>%
#   tbl_summary(by = CH_status, 
#               sort = list(everything() ~ "frequency", ISS ~ "alphanumeric")) %>%
#   bold_labels() %>% add_p(correct = FALSE) %>% bold_p(t = .05) %>% as_gt() %>% 
#   gt::tab_source_note(gt::md("**Data on Drugs patients**"))

```
<br> 
<br>

***

## 7. Survivals by Drugs

All survival analysis are limited to the germline population.

### Drugs `r emo::ji("warning")` here it includes patients with no Drugs

`r emo::ji("pad")` **For OS the time point "zero" is diagnosis.**  
`r emo::ji("pad")` **For PFS the time point "zero" is date of the first drug.**  


### Drugs & ISS

::: {.row}
::: {.col-md-6}
```{r, fig.height = 9}
germline_patient_surv <- drugs_data

mysurv <- Surv(time = germline_patient_surv$month_at_os, event = germline_patient_surv$os_event)

myplot <- survfit(mysurv~ISS, data = germline_patient_surv)
ggsurvplot(myplot, data = germline_patient_surv,
           title = "OS Drugs",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(20, "bold", "black"),
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend = "top",
           legend.title = "",
           # # legend.labs = c("No Treatment", "Treatment"),
           # palette = c("darkred", "darkgreen", "grey"),
           pval = TRUE,
           conf.int = FALSE,
                      xlim = c(-10, 400),
# Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           # Censor
           censor = TRUE
) + guides(linetype = guide_legend(nrow = 2, title = "")) + guides(colour = guide_legend(nrow = 3))
```
:::

::: {.col-md-6}
```{r, fig.height = 7}
tbl1 <- germline_patient_surv %>% select(ISS) %>% 
  tbl_uvregression(method = survival::coxph, 
                   y = (Surv(time = germline_patient_surv$month_at_os, 
                             event = germline_patient_surv$os_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>% 
  bold_labels() %>% italicize_levels()
tbl2 <- coxph(Surv(time = germline_patient_surv$month_at_os, 
             event = germline_patient_surv$os_event) ~ ISS, data =  germline_patient_surv) %>%
  tbl_regression(exponentiate = TRUE)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariate**", "**Multivariate**"))
```
:::
:::

[ **Receiving Drugs increases survival in each ISS group**
]{style="color:red"}

<br> <br>

### Drugs & CH

#### In WES Population

::: {.row}
::: {.col-md-6}
```{r, fig.height = 7}
mysurv <- Surv(time = germline_patient_surv$month_at_os, event = germline_patient_surv$os_event)
myplot <- survfit(mysurv~CH_status, data = germline_patient_surv)
# jpeg(paste0(path, "/Figures/Survivals/CHIP/OS Drugs by CH.jpeg"), width = 1200, height = 900)
ggsurvplot(myplot, data = germline_patient_surv,
           title = "OS Drugs ever",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(10, "bold", "black"), #20
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend = "top",
           legend.title = "",
           # # legend.labs = c("Hipanic", "Non-Hispanic", "Unknown"),
           # palette = c("darkred", "darkgreen", "grey"),
           pval = TRUE,
           conf.int = FALSE,
                      xlim = c(-10, 400),
# Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")),
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(nrow = 2))
```
:::

::: {.col-md-6}
```{r, fig.height = 7}
tbl1 <- germline_patient_surv %>% select(CH_status) %>% 
  tbl_uvregression(method = survival::coxph, 
                   y = (Surv(time = germline_patient_surv$month_at_os, 
                             event = germline_patient_surv$os_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>% 
  bold_labels() %>% italicize_levels()
tbl2 <- coxph(Surv(time = germline_patient_surv$month_at_os, 
             event = germline_patient_surv$os_event) ~ CH_status, data =  germline_patient_surv) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariate**", "**Multivariate**"))
```
:::
:::

<br>

::: {.row}
::: {.col-md-6}
```{r, fig.height = 7}
mysurv <- Surv(time = germline_patient_surv$month_at_progression_drug, event = germline_patient_surv$drug_progression_event)
myplot <- survfit(mysurv~CH_status, data = germline_patient_surv)
ggsurvplot(myplot, data = germline_patient_surv,
           title = "PFS Drugs from  DRUGS date",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(10, "bold", "black"), # 20
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend = "top",
           legend.title = "",
           # # legend.labs = c("Hipanic", "Non-Hispanic", "Unknown"),
           # palette = c("darkred", "darkgreen", "grey"),
           pval = TRUE,
           conf.int = FALSE,
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           # Censor
           # censor = TRUE
) + guides(colour = guide_legend(nrow = 2))
```
:::

::: {.col-md-6}
```{r, fig.height = 7}
tbl1 <- germline_patient_surv %>% select(CH_status) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = germline_patient_surv$month_at_progression_drug,
                             event = germline_patient_surv$drug_progression_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>%
  bold_labels() %>% italicize_levels()
tbl2 <- coxph(Surv(time = germline_patient_surv$month_at_progression_drug,
             event = germline_patient_surv$drug_progression_event) ~ CH_status, data =  germline_patient_surv) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariate**", "**Multivariate**"))
```
:::
:::

<br> 
<br>


#### What if we compare drugs before or after drugs

```{r}
# drugs_data %>%
#   select(drugs_before_germline, time_to_drug, CH_status) %>%
#   tbl_summary(by = CH_status,
#               sort = list(everything() ~ "frequency"),
#               label = list(time_to_drug ~ "Time to Drug", drugs_before_germline ~ "Drugs vs Germline"),
#               missing = "no") %>%
#   bold_labels() %>% add_p(correct = FALSE) %>% bold_p(t = .05) %>% as_gt() %>%
#   gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

drugs_data %>%
  select(drugs_before_germline, CH_status) %>%
  tbl_summary(by = drugs_before_germline,
              sort = list(everything() ~ "frequency"),
              label = list(drugs_before_germline ~ "Drugs vs Germline"),
              missing = "no") %>%
  bold_labels() %>% add_p(correct = FALSE) %>% bold_p(t = .05) %>% as_gt() %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

drugs_data %>%
  group_by(drugs_before_germline, CH_status) %>%
  summarise(count=n()) %>%
  mutate(perc=(count/sum(count)*100)
  ) %>%
  ggplot(aes(x=drugs_before_germline, y = perc, fill = CH_status))+
  geom_bar(stat = "identity")+
  labs(x = "", y = "percent", title = "Patients who had drugs have more CH",
       fill = "CH status") +
  scale_fill_manual(values = c("turquoise3", "snow2"))+
  # scale_x_discrete(labels=c("Drugs after \ngermline", "Drugs before \ngermline"))+
  theme_minimal(base_size = 20)+
  geom_text(aes(label = paste0(round(perc,2), " %")), size = 5, position = position_stack(vjust = 0.5))+
  # geom_text(aes(label = paste0("n=", count)), size = 5, position = position_stack(vjust = 0.25))+
  annotate("text", x = 0, y = 105, label = paste0("p=", chisq.test(table(drugs_data$drugs_before_germline, drugs_data$CH_status), correct = FALSE)[3]),
           color = "black", size = 5, hjust = 0, vjust = 1)

# drugs_data %>%
#   select(drugs_before_germline, ISS) %>%
#   tbl_summary(by = drugs_before_germline,
#               sort = list(everything() ~ "frequency", ISS ~ "alphanumeric"),
#               missing = "no") %>%
#   add_p(correct = FALSE) %>% bold_p(t = .05) %>% bold_labels() %>% as_gt() %>%
#   # gt::tab_source_note(gt::md("*Data for active MM patients only*")) %>%
#   gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

```

# In WES patient who had Blood collected before drugs


::: {.row}
::: {.col-md-6}
```{r, fig.height = 10}
blood_bf_Drugs <- drugs_data %>% 
  filter(drugs_before_germline == "Blood before Drugs")

mysurv <- Surv(time = blood_bf_Drugs$month_at_os, event = blood_bf_Drugs$os_event)
myplot <- survfit(mysurv~CH_status, data = blood_bf_Drugs)
ggsurvplot(myplot, data = blood_bf_Drugs,
           title = "OS",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(20, "bold", "black"),
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend = "top",
           legend.title = "",
           # # legend.labs = c("Hipanic", "Non-Hispanic", "Unknown"),
           # palette = c("darkred", "darkgreen", "grey"),
           pval = TRUE,
           conf.int = FALSE,
                      xlim = c(-10, 150),
# Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")),
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(nrow = 3), linetype = guide_legend(nrow = 3))

```
:::

::: {.col-md-6}
```{r, fig.height = 7}
tbl1 <- blood_bf_Drugs %>% select(CH_status, Age_at_MMonly_diagnosis, Gender, Ethnicity1, Race1, ISS_grp) %>% 
  tbl_uvregression(method = survival::coxph, 
                   y = (Surv(time = blood_bf_Drugs$month_at_os, 
                             event = blood_bf_Drugs$os_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>% 
  bold_labels() %>% italicize_levels()
tbl2 <-
  coxph(Surv(time = blood_bf_Drugs$month_at_os,
             event = blood_bf_Drugs$os_event) ~ CH_status + Age_at_MMonly_diagnosis + Gender + Ethnicity1 + Race1 + ISS_grp, data =  blood_bf_Drugs) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariate**", "**Multivariate**"))
```
:::
:::

::: {.row}
::: {.col-md-6}
```{r, fig.height = 10}
mysurv <- Surv(time = blood_bf_Drugs$month_at_progression_drug, event = blood_bf_Drugs$drug_progression_event)
myplot <- survfit(mysurv~CH_status, data = blood_bf_Drugs)
ggsurvplot(myplot, data = blood_bf_Drugs,
           title = "PFS Drugs from  DRUGS date",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(10, "bold", "black"), # 20
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend = "top",
           legend.title = "",
           # # legend.labs = c("Hipanic", "Non-Hispanic", "Unknown"),
           # palette = c("darkred", "darkgreen", "grey"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-5, 80),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           # Censor
           # censor = TRUE
) + guides(colour = guide_legend(nrow = 2))
```
:::

::: {.col-md-6}
```{r, fig.height = 7}
tbl1 <- blood_bf_Drugs %>% select(CH_status, Age_at_MMonly_diagnosis, Gender, Ethnicity1, Race1, ISS_grp) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = blood_bf_Drugs$month_at_progression_drug,
                             event = blood_bf_Drugs$drug_progression_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>%
  bold_labels() %>% italicize_levels()
tbl2 <- coxph(Surv(time = blood_bf_Drugs$month_at_progression_drug,
             event = blood_bf_Drugs$drug_progression_event) ~ CH_status + Age_at_MMonly_diagnosis + Gender + Ethnicity1 + Race1 + ISS_grp, data =  blood_bf_Drugs) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariate**", "**Multivariate**"))
```
:::
:::

<br>

```{r}
# blood_bf_Drugs %>% 
#   select(CH_status, Disease_Status_germline) %>% 
#   tbl_summary(by = CH_status, label = list(Disease_Status_germline ~ "Disease Status at Blood collection"),
#               sort = list(everything() ~ "frequency"),
#               missing = "no") %>% 
#   bold_labels() %>% as_gt() %>%  
#   gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))
```
<br>

***

# ISS and CH
```{r}
drugs_data %>%
  select(CH_status, ISS) %>%
  tbl_summary(by = ISS,
              sort = list(everything() ~ "frequency", ISS ~ "alphanumeric"),
              missing = "no") %>%
  add_p(correct = FALSE) %>% bold_p(t = .05) %>% bold_labels() %>% as_gt() %>%
  # gt::tab_source_note(gt::md("*Data for active MM patients only*")) %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))

drugs_data %>%
  select(CH_status, ISS_grp) %>%
  tbl_summary(by = ISS_grp,
              sort = list(everything() ~ "frequency", ISS_grp ~ "alphanumeric"),
              missing = "no") %>%
  add_p(correct = FALSE) %>% bold_p(t = .05) %>% bold_labels() %>% as_gt() %>%
  # gt::tab_source_note(gt::md("*Data for active MM patients only*")) %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))
```

::: {.row}
::: {.col-md-6}
```{r, fig.height = 10}
mysurv <- Surv(time = blood_bf_Drugs$month_at_os, event = blood_bf_Drugs$os_event)
myplot <- survfit(mysurv~CH_status+ISS_grp, data = blood_bf_Drugs)
ggsurvplot(myplot, data = blood_bf_Drugs,
           title = "OS",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(20, "bold", "black"),
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend = "top",
           legend.title = "",
           # # legend.labs = c("Hipanic", "Non-Hispanic", "Unknown"),
           # palette = c("darkred", "darkgreen", "grey"),
           color = "CH_status",
           linetype = "ISS_grp",
           pval = TRUE,
           conf.int = FALSE,
                      xlim = c(-10, 150),
# Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")),
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(nrow = 3), linetype = guide_legend(nrow = 3))
```
:::

::: {.col-md-6}
```{r}
tbl1 <- blood_bf_Drugs %>% select(CH_status, ISS_grp, Age_at_MMonly_diagnosis, Gender, Ethnicity1, Race1) %>% 
  tbl_uvregression(method = survival::coxph, 
                   y = (Surv(time = blood_bf_Drugs$month_at_os, 
                             event = blood_bf_Drugs$os_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>% 
  bold_labels() %>% italicize_levels()
tbl2 <-
  coxph(Surv(time = blood_bf_Drugs$month_at_os,
             event = blood_bf_Drugs$os_event) ~ CH_status + ISS_grp + Age_at_MMonly_diagnosis + Gender + Ethnicity1 + Race1, data =  blood_bf_Drugs) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariate**", "**Multivariate**"))
```
:::
:::

::: {.row}
::: {.col-md-6}
```{r, fig.height = 10}
mysurv <- Surv(time = blood_bf_Drugs$month_at_progression_drug, event = blood_bf_Drugs$drug_progression_event)
myplot <- survfit(mysurv~CH_status+ISS_grp, data = blood_bf_Drugs)
ggsurvplot(myplot, data = blood_bf_Drugs,
           title = "PFS Drugs from  DRUGS date",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(10, "bold", "black"), # 20
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend = "top",
           legend.title = "",
           # # legend.labs = c("Hipanic", "Non-Hispanic", "Unknown"),
           # palette = c("darkred", "darkgreen", "grey"),
           color = "CH_status",
           linetype = "ISS_grp",
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-5, 80),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           # Censor
           # censor = TRUE
) + guides(colour = guide_legend(nrow = 2), linetype = guide_legend(nrow = 3))
```
:::

::: {.col-md-6}
```{r}
tbl1 <- blood_bf_Drugs %>% select(CH_status, ISS_grp, Age_at_MMonly_diagnosis, Gender, Ethnicity1, Race1) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = blood_bf_Drugs$month_at_progression_drug,
                             event = blood_bf_Drugs$drug_progression_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>%
  bold_labels() %>% italicize_levels()
tbl2 <- coxph(Surv(time = blood_bf_Drugs$month_at_progression_drug,
             event = blood_bf_Drugs$drug_progression_event) ~ CH_status + ISS_grp + Age_at_MMonly_diagnosis + Gender + Ethnicity1 + Race1, data =  blood_bf_Drugs) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariate**", "**Multivariate**"))
```
:::
:::

<br>

***

# PI, IMIDS

The first table include the name of the **FIRST regimen category** name.  

```{r}
drugs_data %>% 
  mutate(Whole = "Drugs patients") %>% 
  select(regimen_category_1, Whole) %>% 
  tbl_summary(by = Whole,
              sort = list(everything() ~ "frequency")) %>% 
  bold_labels() %>% as_gt()  %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))
```

::: {.row}
::: {.col-md-6}
```{r, fig.height = 10}
mysurv <- Surv(time = drugs_data$month_at_os, event = drugs_data$os_event)
myplot <- survfit(mysurv~regimen_category_1, data = drugs_data)
ggsurvplot(myplot, data = drugs_data,
           title = "OS",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(20, "bold", "black"),
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend = "top",
           legend.title = "",
           # # legend.labs = c("Hipanic", "Non-Hispanic", "Unknown"),
           # palette = c("darkred", "darkgreen", "grey"),
           pval = TRUE,
           conf.int = FALSE,
                      xlim = c(-10, 150),
# Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")),
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(nrow = 3), linetype = guide_legend(nrow = 3))
```
:::

::: {.col-md-6}
```{r}
mysurv <- Surv(time = drugs_data$month_at_progression_drug, event = drugs_data$drug_progression_event)
myplot <- survfit(mysurv~regimen_category_1, data = drugs_data)
ggsurvplot(myplot, data = drugs_data,
           title = "PFS Drugs from  DRUGS date",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(10, "bold", "black"), # 20
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend = "top",
           legend.title = "",
           # # legend.labs = c("Hipanic", "Non-Hispanic", "Unknown"),
           # palette = c("darkred", "darkgreen", "grey"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-5, 80),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           # Censor
           # censor = TRUE
) + guides(colour = guide_legend(nrow = 2), linetype = guide_legend(nrow = 3))
```
:::
:::

<br>

***

# Regimen category and CH

```{r}
drugs_data %>%
  select(CH_status, regimen_category_1) %>%
  tbl_summary(by = CH_status,
              sort = list(everything() ~ "frequency"),
              missing = "no") %>%
  add_p(correct = FALSE) %>% bold_p(t = .05) %>% bold_labels() %>% as_gt() %>%
  # gt::tab_source_note(gt::md("*Data for active MM patients only*")) %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))
```

::: {.row}
::: {.col-md-6}
```{r, fig.height = 10}
mysurv <- Surv(time = drugs_data$month_at_os, event = drugs_data$os_event)
myplot <- survfit(mysurv~CH_status+regimen_category_1, data = drugs_data)
ggsurvplot_facet(myplot, data = drugs_data, facet.by = "regimen_category_1",
           title = "OS",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(20, "bold", "black"),
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend.title = "",
           conf.int = FALSE
) #+ guides(colour = guide_legend(nrow = 4), linetype = guide_legend(nrow = 3))
```
:::

::: {.col-md-6}
```{r}
tbl1 <- drugs_data %>% select(CH_status, regimen_category_1, Age_at_MMonly_diagnosis, Gender, Ethnicity1, Race1) %>% 
  tbl_uvregression(method = survival::coxph, 
                   y = (Surv(time = drugs_data$month_at_os, 
                             event = drugs_data$os_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>% 
  bold_labels() %>% italicize_levels()
tbl2 <-
  coxph(Surv(time = drugs_data$month_at_os,
             event = drugs_data$os_event) ~ CH_status + regimen_category_1 + Age_at_MMonly_diagnosis + Gender + Ethnicity1 + Race1, data =  drugs_data) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariate**", "**Multivariate**"))
```
:::
:::

::: {.row}
::: {.col-md-6}
```{r, fig.height = 10}
mysurv <- Surv(time = drugs_data$month_at_progression_drug, event = drugs_data$drug_progression_event)
myplot <- survfit(mysurv~CH_status+regimen_category_1, data = drugs_data)
ggsurvplot(myplot, data = drugs_data, facet.by = "regimen_category_1",
           title = "PFS Drugs from  DRUGS date",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(10, "bold", "black"), # 20
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend.title = "",
           conf.int = FALSE
) + guides(colour = guide_legend(nrow = 4))
```
:::

::: {.col-md-6}
```{r}
tbl1 <- drugs_data %>% select(CH_status, regimen_category_1, Age_at_MMonly_diagnosis, Gender, Ethnicity1, Race1) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = drugs_data$month_at_progression_drug,
                             event = drugs_data$drug_progression_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>%
  bold_labels() %>% italicize_levels()
tbl2 <- coxph(Surv(time = drugs_data$month_at_progression_drug,
             event = drugs_data$drug_progression_event) ~ CH_status + regimen_category_1 + Age_at_MMonly_diagnosis + Gender + Ethnicity1 + Race1, data =  drugs_data) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariate**", "**Multivariate**"))
```
:::
:::

<br>

***

# CH, regimen in blood before drugs

```{r}
blood_bf_Drugs %>%
  select(CH_status, regimen_category_1) %>%
  tbl_summary(by = CH_status,
              sort = list(everything() ~ "frequency"),
              missing = "no") %>%
  add_p(correct = FALSE) %>% bold_p(t = .05) %>% bold_labels() %>% as_gt() %>%
  # gt::tab_source_note(gt::md("*Data for active MM patients only*")) %>%
  gt::tab_style(style = gt::cell_text(color = "#0099CC"), locations = gt::cells_column_labels(everything()))
```

::: {.row}
::: {.col-md-6}
```{r, fig.height = 10}
mysurv <- Surv(time = blood_bf_Drugs$month_at_os, event = blood_bf_Drugs$os_event)
myplot <- survfit(mysurv~CH_status+regimen_category_1, data = blood_bf_Drugs)
ggsurvplot(myplot, data = blood_bf_Drugs, facet.by = "regimen_category_1",
           title = "OS",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(20, "bold", "black"),
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend.title = "",
           conf.int = FALSE
)# + guides(colour = guide_legend(nrow = 4), linetype = guide_legend(nrow = 3))
```
:::

::: {.col-md-6}
```{r}
tbl1 <- blood_bf_Drugs %>% select(CH_status, regimen_category_1, Age_at_MMonly_diagnosis, Gender, Ethnicity1, Race1) %>% 
  tbl_uvregression(method = survival::coxph, 
                   y = (Surv(time = blood_bf_Drugs$month_at_os, 
                             event = blood_bf_Drugs$os_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>% 
  bold_labels() %>% italicize_levels()
tbl2 <-
  coxph(Surv(time = blood_bf_Drugs$month_at_os,
             event = blood_bf_Drugs$os_event) ~ CH_status + regimen_category_1 + Age_at_MMonly_diagnosis + Gender + Ethnicity1 + Race1, data =  blood_bf_Drugs) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariate**", "**Multivariate**"))
```
:::
:::

::: {.row}
::: {.col-md-6}
```{r, fig.height = 10}
mysurv <- Surv(time = blood_bf_Drugs$month_at_progression_drug, event = blood_bf_Drugs$drug_progression_event)
myplot <- survfit(mysurv~CH_status+regimen_category_1, data = blood_bf_Drugs)
ggsurvplot(myplot, data = blood_bf_Drugs, facet.by = "regimen_category_1",
           title = "PFS Drugs from  DRUGS date",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"),
           font.y = c(20, "bold", "black"),
           font.legend = c(10, "bold", "black"), # 20
           font.tickslab = c(18, "bold", "black"),
           size = 1.5,
           
           xlab = "Time in months", 
           legend.title = "",
           conf.int = FALSE) + guides(colour = guide_legend(nrow = 4), linetype = guide_legend(nrow = 3))
```
:::

::: {.col-md-6}
```{r}
tbl1 <- blood_bf_Drugs %>% select(CH_status, regimen_category_1, Age_at_MMonly_diagnosis, Gender, Ethnicity1, Race1) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = blood_bf_Drugs$month_at_progression_drug,
                             event = blood_bf_Drugs$drug_progression_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>%
  bold_labels() %>% italicize_levels()
tbl2 <- coxph(Surv(time = blood_bf_Drugs$month_at_progression_drug,
             event = blood_bf_Drugs$drug_progression_event) ~ CH_status + regimen_category_1 + Age_at_MMonly_diagnosis + Gender + Ethnicity1 + Race1, data =  blood_bf_Drugs) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariate**", "**Multivariate**"))
```
:::
:::

<br>

***
