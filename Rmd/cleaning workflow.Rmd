---
title: "MM Avatar cleaning"
author: "Christelle Colin-Leitzinger"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: cerulean #darkly
    highlight: pygments
    df_print: paged
---

<style type="text/css">
h1.title {
  font-size: 25px;
}
.figure {
   margin-top: 25px;
   <!-- margin-bottom: 100px; -->
}

table {
    margin-top: 25px;
    <!-- margin-bottom: 100px !important; -->
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")

```

<style>
div.blue { background-color:#0099CC; border-radius: 5px; padding: 20px; font-size: 38px}
</style>
<div class = "blue">

<span style="color: white;">Workflow through the MM Avatar data cleaning</span>

</div>
<br>

```{r library, include=FALSE}
library(tidyverse)
library(data.table)
library(lubridate)
```

***
# I.Clinical data

```{r load}
#######################################################################################  I  ### Load data----
path <- "/Users/colinccm/Documents/GitHub/Gillis/no vpn data/CHIP in Avatar"
# 1.1.Load Demographics data -------------------------------------------------------------------------------------
Demo_RedCap_V4ish <-
  readxl::read_xlsx(paste0(path, "/Raghu MM/extracted Avatar V124 data and dict/Avatar_Demographics_All_MM_modif_06292020.xlsx")) %>%
  select(c("avatar_id","TCC_ID","Date_of_Birth", "Gender", "Ethnicity", "Race"))
Demo_HRI <- 
  readxl::read_xlsx(paste0(path, "/Raghu MM/extracted Avatar V124 data and dict/Demographics_HRI_Export.xlsx")) %>%
  select(c("MRN",Date_of_Birth = "Date of Birth", Gender = "Gender Cerner", Ethnicity = "Ethnicity Cerner", Race = "Race Cerner"))
Demo_linkage <- 
  readxl::read_xlsx(paste0(path, "/Raghu MM/extracted Avatar V124 data and dict/Demographics_HRI_Export.xlsx"),
                    sheet = "Sheet1")
# 1.2.Load Germline with disease status --------------------------------------------------------------------------
Germline <- readxl::read_xlsx(paste0(path, 
                                     "/Raghu MM/Germline data/Moffitt_Germl_v0.4.5_Disease_Classification_12082020.xlsx")) %>% 
  select(c("avatar_id", "SLID_germline", "collectiondt_germline", 
           "moffittSampleId_germline", Disease_Status_germline = "Disease_Status"))
# 1.3.Load Sequencing data ---------------------------------------------------------------------------------------
WES_tumor <-
  readxl::read_xlsx(paste0(path, "/Raghu MM/Germline data/Moffitt_WES_v0.4.3_Disease_Classification_OUT01312020.xlsx")) %>% 
  select(c("avatar_id", "moffitt_sample_id", "collectiondt")) %>% 
  `colnames<-`(c("avatar_id", "moffitt_sample_id_tumor", "collectiondt_tumor"))

#---
Sequencing <-
  read.delim(paste0(path, "/Jamie/v0.4.3.MM.samples.WESdata01.31.20.txt")) %>% 
  select(c(
    "SLID_germline", 
    "SLID_tumor" , "moffitt_sample_id_tumor", 
    "moffitt_sample_id_germline",
    "BaitSet"))
#---
Seq_WES_Raghu <- 
  readxl::read_xlsx(paste0(path, "/Raghu MM/Germline data/MM_Metadata_WES_V044.xlsx")) %>% 
  select(c(avatar_id = "subject", 
           "SLID_germline", "moffitt_sample_id_germline", "collectiondt_germline", 
           "SLID_tumor" , "moffitt_sample_id_tumor", "collectiondt_tumor", 
           "BaitSet"))
#---
Sequencing2 <- # warning message due to a TRUE added in a num var by Raghu (he copy paste an extra patient)
  readxl::read_xlsx(paste0(path, "/Raghu MM/Germline data/MM_Metadata_WES_V0441.xlsx")) %>% 
  select(c(avatar_id = "subject",
           "SLID_germline", moffitt_sample_id_germline = "moffittSampleId_germline",
           "collectiondt_germline",
           "SLID_tumor" , moffitt_sample_id_tumor = "moffittSampleId_tumor", "collectiondt_tumor",
           BaitSet = "baitSet"))
#---
Seq_WES_Raghu2 <- 
  readxl::read_xlsx(paste0(path, "/Raghu MM/Germline data/MM_Metadata_WES_V045.xlsx")) %>% 
  select(c(avatar_id = "subject", 
           "SLID_germline", moffitt_sample_id_germline = "moffittSampleId_germline", "collectiondt_germline", 
           "SLID_tumor" , moffitt_sample_id_tumor = "moffittSampleId_tumor", "collectiondt_tumor", 
           "BaitSet"))

# 1.4.Load Clinical data------------------------------------------------------------------------------------------
# V1 and V2 verified in V4 format
ClinicalCap_V12 <-
  fs::path(
    "/Users/colinccm/Documents/GitHub/Gillis/no vpn data/CHIP in Avatar",
    "Raghu MM",
    "extracted Avatar V124 data and dict",
    "V1V2 verified by CIOX in V4 format"
  )
#---
Vitals_V12 <- Vitals_colnames <- 
  readxl::read_xlsx((paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx")),
                    sheet = "Vitals") %>%
  select(c("avatar_id","vital_status","date_death", date_last_follow_up = "date_of_last_contact"))
# Remove IDs from new CIOX V1V2 in the initial V! and V2 version
uid_V <- paste(unique(Vitals_V12$avatar_id), collapse = '|')

Alc_Smo_V12 <-
  readxl::read_xlsx((paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx")),
                    sheet = "Comorbidities") %>%
  select(c("avatar_id","smoking_status", "alcohol_use"))
uid_A <- paste(unique(Alc_Smo_V12$avatar_id), collapse = '|')
#---
MM_history_V12 <- MM_history_colnames <- 
  readxl::read_xlsx((paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx")),
                    sheet = "Myeloma_Disease_History") %>%
  select(c("avatar_id", "date_of_diagnosis"))
uid_MM <- paste(unique(MM_history_V12$avatar_id), collapse = '|')
#---
Treatment_V12 <- Treatment_colnames <- 
  readxl::read_xlsx((paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx")),
                    sheet = "Treatment") %>%
  select(c("mrn", "avatar_id", "treatment_line_", "drug_start_date", "drug_name_", "drug_stop_date",
           "drug_name_other_")) %>% 
  unite(drug_name_, c(drug_name_,drug_name_other_), sep = ": ", na.rm = TRUE, remove = TRUE) # %>% 
  # rename(drug_other = "drug_name_other_")
uid_T <- paste(unique(Treatment_V12$avatar_id), collapse = '|')
#---
Progression_V12 <-
  readxl::read_xlsx((paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx")),
                    sheet = "Treatment_Outcomes") %>%
  select(c("avatar_id", progression_date = "initial_1_pd_date_1")) # For the non qc'd
Progr_V12 <-
  readxl::read_xlsx((paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx")),
                    sheet = "Treatment") %>%
  select(c("avatar_id", progression_date = "relapse_date", "QC")) # For the qc'd
uid_P <- paste(c(unique(Progression_V12$avatar_id), unique(Progr_V12$avatar_id)), collapse = '|')
#---
SCT_V12 <- SCT_colnames <- 
  readxl::read_xlsx((paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx")),
                    sheet = "SCT") %>%
  select(c("avatar_id","date_of_bmt")) %>%
  drop_na("date_of_bmt")
uid_S <- paste(unique(SCT_V12$avatar_id), collapse = '|')
#---
Radiation_V12 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx"),
                    sheet = "Radiation") %>%
  select(c("avatar_id", "rad_start_date", "rad_stop_date"))
uid_R <- paste(unique(Radiation_V12$avatar_id), collapse = '|')
#---
Labs_V12 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx"),
                    sheet = "Labs") %>%
  select(c("avatar_id", lab_date = "lab_initial_date_1"))
#---
Metastasis_V12 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx"),
                    sheet = "Metastatic_Disease") %>%
  select(c("avatar_id", metastasis_date = "mets_verify_date"))
#---
Staging_V12 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx"),
                    sheet = "Staging") %>%
  select(c("avatar_id", "date_staging_results"))
#---
Imaging_V12 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx"),
                    sheet = "Imaging") %>%
  select(c("avatar_id", "imaging_date"))
#---
Performance_V12 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx"),
                    sheet = "Performance") %>%
  select(c("avatar_id", "date_perf_status_dx"))
#---
TumorMarker_V12 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx"),
                    sheet = "Tumor_marker_flow") %>%
  select(c("avatar_id", "tumor_marker_date"))
#---
Biopsy_V12 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V12, "/Avatar_Legacy_V4_modif_09282020.xlsx"),
                    sheet = "Biopsy") %>%
  select(c("avatar_id", "biopsy_date"))

# V1 ----
ClinicalCap_V1 <-
  fs::path(
    "/Users/colinccm/Documents/GitHub/Gillis/no vpn data/CHIP in Avatar",
    "Raghu MM",
    "extracted Avatar V124 data and dict",
    "V1"
  )
#---
Vitals <-
  readxl::read_xlsx((paste0(ClinicalCap_V1, "/Avatar_MM_Clinical_Data_V1_modif_04292020.xlsx")),
                    sheet = "Vitals") %>%
  select(c("avatar_id","vital_status","date_death", "date_last_follow_up"))
Vitals <- Vitals[(!grepl(uid_V, Vitals$avatar_id)),]

Alc_Smo <-
  readxl::read_xlsx((paste0(ClinicalCap_V1, "/Avatar_MM_Clinical_Data_V1_modif_04292020.xlsx")),
                    sheet = "Vitals") %>%
  select(c("avatar_id", "smoking_status","current_smoker","alcohol_use"))
Alc_Smo <- Alc_Smo[(!grepl(uid_A, Alc_Smo$avatar_id)),]
#---
MM_history <-
  readxl::read_xlsx((paste0(ClinicalCap_V1, "/Avatar_MM_Clinical_Data_V1_modif_04292020.xlsx")),
                    sheet = "Myeloma_Disease_History") %>%
  select(c("avatar_id", "date_of_diagnosis", "disease_stage"))
MM_history <- MM_history[(!grepl(uid_MM, MM_history$avatar_id)),]
#---
Treatment <-
  readxl::read_xlsx((paste0(ClinicalCap_V1, "/Avatar_MM_Clinical_Data_V1_modif_04292020.xlsx")),
                    sheet = "Treatment") %>%
  select(c("avatar_id", drug_start_date = "regimen_start_date", drug_stop_date =  "regimen_end_date",
           "drug1_regimen", "drug2_regimen", "drug3_regimen", 
           "drug4_regimen", "drug5_regimen", "drug6_regimen", "drug7_regimen")) %>% 
  unite(drug_name_, drug1_regimen:drug7_regimen, sep = "; ", na.rm = TRUE, remove = TRUE)

Qcd_Treatment <-
  readxl::read_xlsx((paste0(ClinicalCap_V1, "/Avatar_MM_Clinical_Data_V1_modif_04292020.xlsx")),
                    sheet = "QC'd Treatment") %>%
  select(c("avatar_id", drug_start_date = "regimen_start_date", drug_stop_date = "regimen_end_date",
           drug_name_ = "treatment"))
Treatment <- Treatment[(!grepl(uid_T, Treatment$avatar_id)),]
Qcd_Treatment <- Qcd_Treatment[(!grepl(uid_T, Qcd_Treatment$avatar_id)),]
#---
Progression <-
  readxl::read_xlsx((paste0(ClinicalCap_V1, "/Avatar_MM_Clinical_Data_V1_modif_04292020.xlsx")),
                    sheet = "Treatment") %>%
  select(c("avatar_id", progression_date = "relapse_date"))
Progression <- Progression[(!grepl(uid_P, Progression$avatar_id)),]
#---
SCT <-
  readxl::read_xlsx((paste0(ClinicalCap_V1, "/Avatar_MM_Clinical_Data_V1_modif_04292020.xlsx")),
                    sheet = "SCT") %>%
  select(c("avatar_id","date_of_first_bmt", "date_of_second_bmt", "date_of_third_bmt"))
SCT <- SCT[(!grepl(uid_S, SCT$avatar_id)),]
#---
RadiationV1 <- readxl::read_xlsx(paste0(ClinicalCap_V1, "/Radiation_Version1_Patients.xlsx")) %>%
  select(c("Avatar_ID", "Radiation Start Date", "Radiation End Date")) %>% 
  `colnames<-`(c("avatar_id", "rad_start_date", "rad_stop_date"))
RadiationV1 <- RadiationV1[(!grepl(uid_R, RadiationV1$avatar_id)),]
#---
Biopsy <-
  readxl::read_xlsx((paste0(ClinicalCap_V1, "/Avatar_MM_Clinical_Data_V1_modif_04292020.xlsx")),
                    sheet = "Biopsy") %>%
  select(c("avatar_id", biopsy_date = "date_bonemarrow_biopsy_results"))
#---
Staging <- 
  readxl::read_xlsx(paste0(ClinicalCap_V1, "/Avatar_MM_Clinical_Data_V1_modif_04292020.xlsx"),
                    sheet = "Biopsy") %>%
  select(c("avatar_id", "date_staging_results"))
#---
Imaging <- 
  readxl::read_xlsx(paste0(ClinicalCap_V1, "/Avatar_MM_Clinical_Data_V1_modif_04292020.xlsx"),
                    sheet = "Biopsy") %>%
  select(c("avatar_id", imaging_date = "date_radiologicexam"))
#---
LabsV1 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V1, "/Avatar_MM_Clinical_Data_V1_modif_04292020.xlsx"),
                    sheet = "Biopsy") %>%
  select(c("avatar_id", "date_upep", "date_spep", "date_paraprotein_results",
           "date_flowcytometry_dna_"))
# V2 ----
ClinicalCap_V2 <-
  fs::path(
    "/Users/colinccm/Documents/GitHub/Gillis/no vpn data/CHIP in Avatar",
    "Raghu MM",
    "extracted Avatar V124 data and dict",
    "V2"
  )
#---
VitalsV2 <-
  readxl::read_xlsx((paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx")),
                    sheet = "Vitals") %>%
  select(c("avatar_id","vital_status","date_death"))
VitalsV2 <- VitalsV2[(!grepl(uid_V, VitalsV2$avatar_id)),]

Alc_Smo_V2 <-
  readxl::read_xlsx((paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx")),
                    sheet = "Vitals") %>%
  select(c("avatar_id", "smoking_status","alcohol_use")) # remove BMI
Alc_Smo_V2 <- Alc_Smo_V2[(!grepl(uid_A, Alc_Smo_V2$avatar_id)),]
#---
MM_historyV2 <-
  readxl::read_xlsx((paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx")),
                    sheet = "Myeloma_Disease_History") %>%
  select(c("avatar_id",  "date_of_diagnosis"))
MM_historyV2 <- MM_historyV2[(!grepl(uid_MM, MM_historyV2$avatar_id)),]
#---
TreatmentV2 <-
  readxl::read_xlsx((paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx")),
                    sheet = "Treatment") %>%
  select(c("avatar_id", "treatment_line_", "drug_start_date" , "drug_name_", "drug_stop_date",
           "drug_name_other")) %>% 
  unite(drug_name_, c(drug_name_,drug_name_other), sep = ": ", na.rm = TRUE, remove = TRUE)
Qcd_TreatmentV2 <-
  readxl::read_xlsx((paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx")),
                    sheet = "QC'd Treatment") %>%
  select(-relapse_date, -"...7")
TreatmentV2 <- TreatmentV2[(!grepl(uid_T, TreatmentV2$avatar_id)),]
Qcd_TreatmentV2 <- Qcd_TreatmentV2[(!grepl(uid_T, Qcd_TreatmentV2$avatar_id)),]
#---
ProgressionV2 <-
  readxl::read_xlsx((paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx")),
                    sheet = "Treatment") %>%
  select(c("avatar_id", progression_date = "relapse_date"))
ProgressionV2 <- ProgressionV2[(!grepl(uid_P, ProgressionV2$avatar_id)),]
#---
SCTV2 <-
  readxl::read_xlsx((paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx")),
                    sheet = "SCT") %>%
  select(c("avatar_id", "date_of_first_bmt", "date_of_second_bmt", "date_of_third_bmt"))
SCTV2 <- SCTV2[(!grepl(uid_S, SCTV2$avatar_id)),]
#---
RadiationV2 <- readxl::read_xlsx((paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx")),
                                 sheet = "Radiation") %>%
  select(c("avatar_id", "rad_start_date_v2", "rad_stop_date_v2")) %>% 
  `colnames<-`(c("avatar_id", "rad_start_date", "rad_stop_date"))
RadiationV2 <- RadiationV2[(!grepl(uid_R, RadiationV2$avatar_id)),]
#---
BiopsyV2 <-
  readxl::read_xlsx((paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx")),
                    sheet = "Biopsy") %>%
  select(c("avatar_id", biopsy_date = "date_bonemarrow_biopsy_results"))
#---
PerformanceV2 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx"),
                    sheet = "Performance") %>%
  select(c("avatar_id", date_perf_status_dx = "date_perf_status"))
#---
ImagingV2 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx"),
                    sheet = "Imaging") %>%
  select(c("avatar_id", imaging_date = "date_radiologicexam"))
#---
StagingV2 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx"),
                    sheet = "Staging") %>%
  select(c("avatar_id", "date_staging_results"))
#---
LabsV2 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V2, "/Avatar_MM_Clinical_Data_V2_modif_05042020.xlsx"),
                    sheet = "Biopsy") %>%
  select(c("avatar_id", "date_upep", "date_spep", "date_paraprotein_results"))
# V4 ----
ClinicalCap_V4 <-
  fs::path(
    "/Users/colinccm/Documents/GitHub/Gillis/no vpn data/CHIP in Avatar",
    "Raghu MM",
    "extracted Avatar V124 data and dict",
    "V4"
  )
#---
VitalsV4 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx")),
                    sheet = "Vitals") %>%
  select(c("avatar_id","vital_status","date_death", date_last_follow_up = "date_of_last_contact"))
#---
MM_historyV4 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx")),
                    sheet = "Myeloma_Disease_History") %>%
  select(c("avatar_id", "date_of_diagnosis"))
#---
Alc_SmoV4 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx")),
                    sheet = "Comorbidities") %>%
  select(c("avatar_id","smoking_status", "alcohol_use"))
#---
TreatmentV4 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx")),
                    sheet = "Treatment") %>%
  select(c("avatar_id", "treatment_line_", "drug_start_date", "drug_name_", "drug_stop_date",
           "drug_name_other")) %>% 
  unite(drug_name_, c(drug_name_,drug_name_other), sep = ": ", na.rm = TRUE, remove = TRUE)# %>% 
#---
Progression_V4 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx")),
                    sheet = "Treatment_Outcomes") %>%
  select(c("avatar_id", progression_date = "initial_1_pd_date_1"))
#---
SCTV4 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx")),
                    sheet = "SCT") %>%
  select(c("avatar_id", "date_of_bmt")) %>%  # can be different than first if duplicated from v1 or v2
  drop_na("date_of_bmt")
#---
RadiationV4 <- 
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx")),
                    sheet = "Radiation") %>%
  select(c("avatar_id", "rad_start_date", "rad_stop_date"))
#---
LabsV4 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx"),
                    sheet = "Labs") %>%
  select(c("avatar_id", lab_date = "lab_initial_date_1"))
#---
MetastasisV4 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx"),
                    sheet = "Metastatic_Disease") %>%
  select(c("avatar_id", metastasis_date = "mets_verify_date"))
#---
StagingV4 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx"),
                    sheet = "Staging") %>%
  select(c("avatar_id", "date_staging_results"))
#---
ImagingV4 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx"),
                    sheet = "Imaging") %>%
  select(c("avatar_id", "imaging_date"))
#---
PerformanceV4 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx"),
                    sheet = "Performance") %>%
  select(c("avatar_id", "date_perf_status_dx"))
#---
TumorMarkerV4 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx"),
                    sheet = "Tumor_marker_flow") %>%
  select(c("avatar_id", "tumor_marker_date"))
#---
BiopsyV4 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_modif_04272020.xlsx"),
                    sheet = "Biopsy") %>%
  select(c("avatar_id", biopsy_date = "date_bonemarrow_biopsy_results"))

# V4.august2020 ----
#
VitalsV4.1 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx")),
                    sheet = "Vitals") %>%
  select(c("avatar_id","vital_status","date_death", date_last_follow_up = "date_of_last_contact"))
#
MM_historyV4.1 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx")),
                    sheet = "Myeloma_Disease_History") %>%
  select(c("avatar_id", "date_of_diagnosis"))
#
Alc_SmoV4.1 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx")),
                    sheet = "Comorbidities") %>%
  select(c("avatar_id","smoking_status", "alcohol_use"))
#
TreatmentV4.1 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx")),
                    sheet = "Treatment") %>%
  select(c("avatar_id", "treatment_line_", "drug_start_date", "drug_name_", "drug_stop_date",
           "drug_name_other_")) %>% 
  unite(drug_name_, c(drug_name_,drug_name_other_), sep = ": ", na.rm = TRUE, remove = TRUE)
#
Progression_V4.1 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx")),
                    sheet = "Treatment_Outcomes") %>%
  select(c("avatar_id", progression_date = "initial_1_pd_date_1"))
#
SCTV4.1 <-
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx")),
                    sheet = "SCT") %>%
  select(c("avatar_id", "date_of_bmt")) %>%  # can be different than first if duplicated from v1 or v2
  drop_na("date_of_bmt")
#
RadiationV4.1 <- 
  readxl::read_xlsx((paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx")),
                    sheet = "Radiation") %>%
  select(c("avatar_id", "rad_start_date", "rad_stop_date"))
#
LabsV4.1 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx"),
                    sheet = "Labs") %>%
  select(c("avatar_id", lab_date = "lab_initial_date_1"))
#
MetastasisV4.1 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx"),
                    sheet = "Metastatic_Disease") %>%
  select(c("avatar_id", metastasis_date = "mets_verify_date"))
#
StagingV4.1 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx"),
                    sheet = "Staging") %>%
  select(c("avatar_id", "date_staging_results"))
#
ImagingV4.1 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx"),
                    sheet = "Imaging") %>%
  select(c("avatar_id", "imaging_date"))
#
PerformanceV4.1 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx"),
                    sheet = "Performance") %>%
  select(c("avatar_id", "date_perf_status_dx"))
#
TumorMarkerV4.1 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx"),
                    sheet = "Tumor_marker_flow") %>%
  select(c("avatar_id", "tumor_marker_date"))
#
BiopsyV4.1 <- 
  readxl::read_xlsx(paste0(ClinicalCap_V4, "/Avatar_MM_Clinical_Data_V4_OUT_08032020 .xlsx"),
                    sheet = "Biopsy") %>%
  select(c("avatar_id", biopsy_date = "date_bonemarrow_biopsy_results"))
#
OS_data <- readxl::read_xlsx(paste0(path, "/Raghu MM/Overall Survival/HRI_Last_Followupdata.xlsx")) %>% 
  select(avatar_id = "germline_patient_data_avatar_id", "final_vitals", "Vital_Status_Date") %>% 
  distinct()
#
Staging_ISS <- readxl::read_xlsx(paste0(path, "/Raghu MM/Staging_09142020.xlsx")) %>% 
  select("avatar_id", "collectiondt_germline", "Labs_Result_Date", "Final_Albumin", "Final_Beta2", "Final_LDH", "ISS") %>% 
  mutate(ISS = str_replace(ISS, pattern = "NA", replacement = NA_character_)) %>% 
  arrange(collectiondt_germline) %>% 
  distinct(avatar_id, .keep_all = TRUE) # remove the duplicate of patient 180
#
CHIP_status <- read_csv(paste0(path, "/Nancy's working files/CHcalls_12.10.20.csv")) %>% 
  # mutate(CH_status = ifelse(CH_status == "CH", "CHIP", "No CHIP")) %>% 
  mutate(patient_germline_id = str_remove(patient_germline_id, "_normal"))
#
IMIDS_maintenance <- readxl::read_xlsx(paste0(path, "/Raghu MM/MM_Maintainance_Regimen.xlsx"))
#
migration_patients <- readxl::read_xlsx(paste0(path, "/Raghu MM/Avatar List For Migration.xlsx"))

path <- fs::path("","Volumes","Gillis_Research","Christelle Colin-Leitzinger", "CHIP in Avatar")
```

-In total, we have 4 versions of the clinical data.  
V1 has `r MM_history %>% distinct(avatar_id) %>% NROW()` patients and was sent by Raghu on Feb, 07th 2020.  
V2 has `r MM_historyV2 %>% distinct(avatar_id) %>% NROW()` patients and was sent by Raghu on Feb, 10th 2020.  
V4 has `r MM_historyV4 %>% distinct(avatar_id) %>% NROW()` patients and was sent by Raghu on April, 21st 2020.  
A V4.1, a complementary data, added `r MM_historyV4.1 %>% distinct(avatar_id) %>% NROW()` patients to V4 on August, 03rd 2020.  
V12 (which is V4 legacy) has `r MM_history_V12 %>% distinct(avatar_id) %>% NROW()` patients and was sent by Raghu on Sept, 04th 2020. This data overlap V1 and V2 patients with some patients data which were updated by CIOX and reformatted to a V4 format, and patients for who the data were only reformatted to a V4 format but not verified.  
For that reason, before I bind all the version, I removed all the ids present in V12 from V1 and V2 to avoid duplicate. I prefer to do that before the binding because all the variable present in V1 or V2 are not present in V12 and vice versa, so I may not be able to use the distinct function to remove the duplicated rows.
-We learned in Feb 2021 that CIOX contract was stopped.  
-Radiation data are not present in V1 so Raghu sent me another file with them pulled from HRI on March 14th 2020.  
-The ISS staging was calculated by Raghu and sent on Sept 14th 2020. It doesn't use cytogenetics features. The ISS is calculated on all patients MM, Smoldering and Mgus, a later cleaning only kept the ISS for the patients who are MM ("Pre Treatment Newly Diagnosed Multiple Myeloma","Post Treatment Newly Diagnosed Multiple Myeloma","Early Relapse Multiple Myeloma","Late Relapse Multiple Myeloma") at the time of germline collection.  
-The IMIDS maintenance file was sent by Raghu on Dec 29th 2020 that he   *"queried from raw datasets of Avatar legacy v4 MM cases which matched to our patient list. There are about 135 cases (from v045) that are awaiting qc of migration(clinical data), follow up data. I have not used these cases for querying and about 90 cases of these patients list are v1 cases where forms were not designed to capture maintenance regimen data."*  
-Comments on tretment line: Raghu said that *"Original data (regimen line variable) comes as numbers with different values in V4 form. There is some missing data and some values are not very relevant to Myeloma since V4 forms are not disease specific, so Dr. Shain recommended me to reformat the variable."*  

## Germline
We received many files.  

First set data:  
WES_tumor = Moffitt_WES_v0.4.3_Disease_Classification_OUT**01312020**.xlsx from Raghu has the `collectiondt_tumor` and `moffitt_sample_id_tumor`
Sequencing = v0.4.3.MM.samples.WESdata**01.31.20**.txt" from Jamie have `SLID_germline`, `SLID_tumor`, `moffitt_sample_id_tumor`, `moffitt_sample_id_germline` but no date associated.
Join them together using `moffitt_sample_id_tumor`

Second set data:  
Seq_WES_Raghu = MM_Metadata_WES_V044.xlsx 03/31/2020 from Raghu has `SLID_germline`, `moffitt_sample_id_germline`,
`collectiondt_germline`, `SLID_tumor`, `moffitt_sample_id_tumor`, `collectiondt_tumor`.

Third set data:  
Sequencing2 = MM_Metadata_WES_V0441.xlsx" 05/05/202 from Raghu has `SLID_germline`, `moffitt_sample_id_germline`,
`collectiondt_germline`, `SLID_tumor`, `moffitt_sample_id_tumor`, `collectiondt_tumor`.
Fourth set data:  
Seq_WES_Raghu2 = MM_Metadata_WES_V045.xlsx 07/20/2020 from Raghu has `SLID_germline`, `moffitt_sample_id_germline`,
`collectiondt_germline`, `SLID_tumor`, `moffitt_sample_id_tumor`, `collectiondt_tumor`.

Take the 4 sets, bind and pivot to have 1 patient/germline per row.
Then join that new data to `Germline`.  
Germline = Moffitt_Germl_v0.4.5_Disease_Classification_**12082020**.xlsx which has `SLID_germline`,
`collectiondt_germline`, `moffittSampleId_germline`, `Disease_Status_germline.` but no tumor info. That was the last update that Raghu has on germline info (3 patients have missing collection date in the 4 set-data which is filled by the newest version).

The data created will have all tumor and germline info (1 patient per row).
  
Sometimes no date of collection? -> Not really, it is the 2 patients who will be removed at the end.

```{r}
Germline <- Germline %>% 
  distinct()

Sequencing <-
  full_join(
    Sequencing,
    WES_tumor,
    by = "moffitt_sample_id_tumor")
# Bind Sequencing
Seq_WES <- bind_rows(Seq_WES_Raghu, Sequencing2, Seq_WES_Raghu2, Sequencing, .id = "vers") %>% 
  arrange(collectiondt_germline) %>% 
  distinct(SLID_tumor, moffitt_sample_id_tumor, SLID_germline, .keep_all = TRUE)

Seq_WES <- Seq_WES[order(Seq_WES$collectiondt_tumor), ]
# pivot wider
WES_seq <-
  dcast(setDT(Seq_WES), avatar_id+SLID_germline+moffitt_sample_id_germline+collectiondt_germline ~ rowid(avatar_id),
        value.var = c(
          "SLID_tumor",
          "moffitt_sample_id_tumor",
          "collectiondt_tumor",
          "BaitSet"
        )
  )

# Merge all
Germline <- left_join(WES_seq, Germline, by = "avatar_id") %>% 
  filter(SLID_germline.x == SLID_germline.y | is.na(SLID_germline.x == SLID_germline.y)) %>% 
  rename(SLID_germline = "SLID_germline.x", collectiondt_germline = "collectiondt_germline.x") %>% 
  # distinct(avatar_id, SLID_germline, .keep_all = TRUE) %>% 
  mutate(collectiondt_germline = coalesce(collectiondt_germline, collectiondt_germline.y)) %>% 
  select(-SLID_germline.y, -collectiondt_germline.y)
Germline
```

## Demographics
Demographics only has 3 versions that can be join together. Some cleaning is done : recode "African American" as "Black" or "Spanish; Hispanic" as "Hispanic" for example.
```{r}
Demo_HRI <- full_join(Demo_linkage, Demo_HRI, by= "MRN") %>% 
  distinct(.) %>% 
  mutate(MRN = as.character(MRN))
Demo_HRI$Date_of_Birth <- as.POSIXct(strptime(Demo_HRI$Date_of_Birth, 
                                                  format = "%m/%d/%Y", tz = "UTC"))
uid <- paste(unique(Demo_RedCap_V4ish$avatar_id), collapse = '|')
Demo_HRI <- Demo_HRI[(!grepl(uid, Demo_HRI$avatar_id)),]
Demo_RedCap_V4ish <- bind_rows(Demo_RedCap_V4ish, Demo_HRI, .id = "versionDemo")
Demo_RedCap_V4ish <- Demo_RedCap_V4ish %>% 
  mutate(Race = case_when(
    Race %in% c("African American")                           ~ "Black",
    Race %in% c("Other")                                      ~ "Others",
    Race %in% c("More Than One Race")                         ~ "More than one race",
    Race %in% c("Other Asian including Asian and Oriental")   ~ "Asian",
    Race %in% c("PT Not Present")                             ~ "Unknown",
    Race %in% c("AM INDIAN")                                  ~ "Am Indian",
    TRUE                                                      ~ Race
  )) %>% 
  mutate(Race = factor(Race, levels=c("White", "Black", "Am Indian", "Asian", "More than one race", "Others", "Unknown"))) %>% 
  mutate(Ethnicity = case_when(
    Ethnicity %in% c("Spanish; Hispanic")                                   ~ "Hispanic",
    Ethnicity %in% c("Non- Hispanic", "Non-Spanish; non-Hispanic")          ~ "Non-Hispanic",
    Ethnicity %in% c("Unknown", "Prefer not to answer", "PT Not Present")   ~ "Unknown",
    TRUE                                                                    ~ Ethnicity
  ))
Demo_RedCap_V4ish
```


## MM history
```{r}
mm_history <- bind_rows(MM_history_V12, MM_history, MM_historyV2, MM_historyV4, MM_historyV4.1, .id = "versionMM") %>%
  drop_na("date_of_diagnosis") %>%
  distinct(avatar_id, date_of_diagnosis, .keep_all = TRUE) %>% 
  # Create date of diagnosis closest to germline date
  left_join(., Germline %>% distinct(avatar_id, .keep_all = TRUE) %>% select("avatar_id", "collectiondt_germline"), # For only 1 date of Dx when multiple germline collection
            by = "avatar_id") %>% 
  mutate(interval = (interval(start= .$collectiondt_germline, end= .$date_of_diagnosis)/duration(n=1, unit="days"))) %>% 
  mutate(interval1 = if_else(interval>100, NA_real_, interval)) %>% 
  mutate(interval1 = abs(interval1)) %>% 
  arrange(interval1) %>% 
  group_by(avatar_id) %>% mutate(id = 1:n()) %>% ungroup() %>%
  mutate(Dx_date_closest_germline = if_else(id == 1, date_of_diagnosis, NA_POSIXct_)) %>% 
  distinct(avatar_id, date_of_diagnosis, .keep_all = TRUE) %>% 
  group_by(avatar_id) %>% fill(Dx_date_closest_germline, .direction = "updown") %>% 
  arrange(avatar_id, date_of_diagnosis) %>% 
  ungroup()

MM_history <- dcast(setDT(mm_history), avatar_id+Dx_date_closest_germline ~ rowid(avatar_id), 
                    value.var = c("date_of_diagnosis", "disease_stage")) %>% 
  mutate(date_of_MMonly_diagnosis = case_when(
    disease_stage_1 == "active"          ~ date_of_diagnosis_1,
    disease_stage_2 == "active"          ~ date_of_diagnosis_2,
    disease_stage_3 == "active"          ~ date_of_diagnosis_3,
    disease_stage_4 == "active"          ~ date_of_diagnosis_4,
  )) %>% 
  mutate(date_of_MMSMMGUSdiagnosis = coalesce(date_of_MMonly_diagnosis, date_of_diagnosis_1)) %>% 
  select(c("avatar_id", "Dx_date_closest_germline", "date_of_MMonly_diagnosis", "date_of_MMSMMGUSdiagnosis", everything()))
```
All MM history are bind together and duplicated rows are removed.
The date of diagnosis are multiple for each patients. It could be the first time they got a Mgus, Smoldering or MM diagnosis. It can also be when the patient become MM or when he relapse. The `disease_stage` associated with the `date_of_diagnosis` tells us if the patient is within this 4 conditions.  
The data is pivoted wider to have 1 patient per row.
`r table(MM_history$disease_stage_1)`
By binding with the `collectiondt_germline` I was able to calculate an interval between the later and the multiple `date_of_diagnosis`.
We choose to take the date closest to germline (with closest absolute interval as long as it is not nore than 100 days after the germline) as the `Dx_date_closest_germline`. <span style='color: red;'>The problem can be when the disease stage is not recorded.</span>  
I also created a `date_of_MMonly_diagnosis` variable which take the first diagnosis date where the disease status is active (MM diagnosis). Comment: it doesn't take the relapse diagnosis...<span style='color: red;'>Should it?</span>  
`date_of_MMSMMGUSdiagnosis` takes `date_of_MMonly_diagnosis` and NA are filled with the very first diagnosis date of non-active disease in the data.

FYI, I give all the variable names but I am using only few of them for now.
```{r}
colnames(MM_history_colnames)
mm_history
MM_history
```

## Vitals
```{r}
Vitals <- bind_rows(Vitals_V12, Vitals, VitalsV2, VitalsV4, VitalsV4.1, .id = "versionVit") %>% 
  distinct() %>% 
  arrange(vital_status, date_death, date_last_follow_up)

# Create a separate df to bind after cleaning to Vitals for tracking lost of contact
Contact_lost <- Vitals %>% 
  filter(vital_status == 3) %>% 
  mutate(was_contact_lost = "Loss of contact") %>% 
  distinct(.) %>% 
  select(c("avatar_id", "was_contact_lost", date_contact_lost = "date_last_follow_up"))

# Pivot wider
Vitals <- dcast(setDT(Vitals), avatar_id ~ rowid(avatar_id), 
                value.var = c("vital_status", "date_death", 
                              "date_last_follow_up")) %>% 
  purrr::keep(~!all(is.na(.))) %>%
  mutate(date_last_follow_up = coalesce(!!! select(., last_col():"date_last_follow_up_1"))) %>%
  mutate(date_death = coalesce(!!! select(., starts_with("date_death_")))) %>% 
  select(c("avatar_id", "date_death", "date_last_follow_up"))

Vitals <- full_join(Vitals, Contact_lost, by= "avatar_id") %>% 
  # Remove the last date of follow up when is contact lost, otherwise would have doubled `last_date_available` in the future
  mutate(date_last_follow_up = case_when( 
    !is.na(date_contact_lost)   ~ NA_POSIXct_,
    is.na(date_contact_lost)    ~ date_last_follow_up
  )) 
```
All Vitals are bind together and duplicated rows are removed.
I created a variable `date_contact_lost` for when `was_contact_lost` is "Loss of contact".
It can have multiple `date_last_follow_up` so I kept the latest one only.

```{r}
colnames(Vitals_colnames)
Vitals
```

## SCT
```{r}
SCT <- SCT %>% pivot_longer(cols = c(date_of_first_bmt, date_of_second_bmt, date_of_third_bmt),
                             values_to = "date_of_bmt", values_drop_na = TRUE)
SCTV2 <- SCTV2 %>% pivot_longer(cols = c(date_of_first_bmt, date_of_second_bmt, date_of_third_bmt),
                             values_to = "date_of_bmt", values_drop_na = TRUE)

sct <- bind_rows(SCT_V12, SCT, SCTV2, SCTV4, SCTV4.1, .id = "versionSCT") %>% 
  distinct(avatar_id, date_of_bmt) %>% 
  arrange(date_of_bmt)
SCT <- dcast(setDT(sct), avatar_id ~ rowid(avatar_id), 
             value.var = "date_of_bmt") %>% 
  `colnames<-`(c("avatar_id", "date_of_bmt_1", "date_of_bmt_2", "date_of_bmt_3"))
```
Version 1 and 2 are wide (1 patient per row) and V4 format is in a long version so I first pivoted longer 1 and 2 before binding them. Then I remove the duplicated rows and finally pivot wider this time to have 1 patient per row.


```{r}
colnames(SCT_colnames)
SCT
```

## Treatment

```{r}
IMIDS_maintenance <- IMIDS_maintenance %>% 
  unite(drug_name_, drug_name_:drug_name_other, sep = ": ", remove = FALSE, na.rm = TRUE) %>%
  mutate(imids_maintenance = case_when(
    str_detect(drug_name_, "lidomide")    ~ "IMIDs as maintenance",
    TRUE                                  ~ "no IMIDs as maintenance"
  )) %>% 
  full_join(migration_patients, ., by = "avatar_id") %>% 
  mutate(imids_maintenance = ifelse(is.na(imids_maintenance), "not qc'd", imids_maintenance)) %>% 
  arrange(imids_maintenance) %>% 
  distinct(avatar_id, .keep_all = TRUE) %>% 
  select("avatar_id", "imids_maintenance")

# remove NA row in QC'd data
Qcd_Treatment <- Qcd_Treatment %>% drop_na("drug_start_date", "drug_name_")
Qcd_TreatmentV2 <- Qcd_TreatmentV2 %>% drop_na("drug_start_date", "drug_name_") %>%
  arrange(drug_start_date) %>% 
  group_by(avatar_id) %>% 
  mutate(treatment_line_1 = as.character(dense_rank(interaction(avatar_id, drug_start_date)))) %>% 
  mutate(treatment_line_ = coalesce(treatment_line, treatment_line_1)) %>% select(-treatment_line, -treatment_line_1)
# remove the Ids found in Qc'd from the Treatment 
uid <- paste(unique(Qcd_Treatment$avatar_id), collapse = '|')
Treatment <- Treatment[(!grepl(uid, Treatment$avatar_id)),]
uid <- paste(unique(Qcd_TreatmentV2$avatar_id), collapse = '|')
TreatmentV2 <- TreatmentV2[(!grepl(uid, TreatmentV2$avatar_id)),]
# Bind QC'd and Treatment for each version
# Need to pivot longer Treatment from V1 (and V2) because not same formatting
# Having one drug per row will help to remove duplicate in drugs after binding all version together
Treatment <- bind_rows(Qcd_Treatment, Treatment) %>% 
  filter(drug_name_ != "Non-MM drugs") %>% 
  group_by(avatar_id) %>% 
  arrange(drug_start_date) %>% 
  mutate(treatment_line_ = as.character(row_number())) %>% 
  # mutate_at(("drug_name_"), ~ str_replace_all(., "/", ": ")) %>% 
  separate(col = drug_name_, paste("drug_name_", 1:10, sep=""), sep = "; |;", extra = "warn", 
           fill = "right") %>% 
  purrr::keep(~!all(is.na(.))) %>%
  pivot_longer(cols = starts_with("drug_name_"),
               names_to = "drug", values_to = "drug_name_", values_drop_na = TRUE)


TreatmentV2 <- TreatmentV2 %>% 
  group_by(avatar_id, drug_start_date) %>% 
  arrange(drug_start_date, treatment_line_) %>% 
  fill(treatment_line_, .direction = "updown") %>% 
  # group_by(avatar_id) %>% 
  # # mutate(treatment_line = dense_rank(interaction(avatar_id, drug_start_date))) %>% 
  # fill(treatment_line, .direction = "downup") %>%  # is not the best way, could do a 30 days rule
  ungroup() %>% 
  bind_rows(Qcd_TreatmentV2, .) %>% 
  separate(col = drug_name_, paste("drug_name_", 1:7, sep=""), sep = "; |;", extra = "warn", 
           fill = "right") %>% 
  purrr::keep(~!all(is.na(.))) %>%
  pivot_longer(cols = starts_with("drug_name_"),
               names_to = "drug", values_to = "drug_name_", values_drop_na = TRUE)

Treatment_V12 <- Treatment_V12 %>% 
  separate(col = drug_name_, paste("drug_name_", 1:7, sep=""), sep = "\\+", extra = "warn", # Just for 1 row
           fill = "right") %>% 
  purrr::keep(~!all(is.na(.))) %>%
  pivot_longer(cols = starts_with("drug_name_"),
               names_to = "drug", values_to = "drug_name_", values_drop_na = TRUE)

# ready to bind
treatment <- bind_rows(Treatment_V12, Treatment, TreatmentV2, TreatmentV4, TreatmentV4.1, .id = "versionTreat") %>%
  mutate(treatment_line_ = case_when(
    str_detect(treatment_line_, "Tenth|10") ~ 10,
    str_detect(treatment_line_, "Eleventh|11") ~ 11,
    str_detect(treatment_line_, "Twelth|12") ~ 12,
    str_detect(treatment_line_, "Thirteenth|13") ~ 13,
    str_detect(treatment_line_, "Fourteenth|14") ~ 14,
    str_detect(treatment_line_, "Fifteenth|15") ~ 15,
    str_detect(treatment_line_, "Sixteenth|16") ~ 16,
    str_detect(treatment_line_, "First|1") ~ 1,
    str_detect(treatment_line_, "Second|2") ~ 2,
    str_detect(treatment_line_, "Third|3") ~ 3,
    str_detect(treatment_line_, "Fourth|4") ~ 4,
    str_detect(treatment_line_, "Fifth|5") ~ 5,
    str_detect(treatment_line_, "Sixth|6") ~ 6,
    str_detect(treatment_line_, "Seventh|7") ~ 7,
    str_detect(treatment_line_, "Eighth|8") ~ 8,
    str_detect(treatment_line_, "Ninth|9") ~ 9,
    treatment_line_ == "Maintenance"             ~ 90,
    treatment_line_ == "Palliative"              ~ 91,
    str_detect(treatment_line_, "Unknown")       ~ 99
  )) %>% 
  select(mrn, avatar_id, treatment_line_, drug_start_date, drug_stop_date, drug_name_) %>% 
  mutate(drug_name_ = tolower(drug_name_)) %>%
  mutate(drug_name_ = 
           str_remove_all(drug_name_, 
          "given with |investigational agent: |investigational therapy: |investigational therapy : |clinical trial: |clinical trial; |clinical trial-|clinical trial | sulfate|clinical trial/|other: |  |clinical trial|oral proteasome inhibitor = ")) %>%
  mutate(drug_name_ = case_when(
    drug_name_ == "cafilzomib"                                             ~ "carfilzomib",
    drug_name_ == "daratumuab"                                             ~ "daratumumab",
    str_detect(drug_name_, "^dex")                                         ~ "dexamethasone",
    str_detect(drug_name_, "^lena|revlimid")                               ~ "lenalidomide",
    str_detect(drug_name_, "^mel")                                         ~ "melphalan",
    str_detect(drug_name_, "velcade")                                      ~ "bortezomib",
    drug_name_ == "vinicristine"                                           ~ "vincristine",
    drug_name_ %in% c("anastrozole", "azacitidine", "carmustine", 
                      "cytarabine", "decitabine", "denosumab", 
                      "docetaxel", "hydrocortisone", "methotrexate",
                      "methylprednisolone", "pegfilgrastim", "prednisone", 
                      "rapamycin", "rituxan", "rituximab", 
                      "sorafenib tosylate", "tamoxifen citrate", 
                      "zoledronic acid", "prevnar", "ruxolitinib")         ~ "non-mm drugs",
    TRUE                                                                   ~ drug_name_
  )) %>% 
  mutate(drug_name_ = str_replace_all(drug_name_, "liposomal doxorubicin", "doxil")) %>% 
  mutate(drug_name_ = str_replace_all(drug_name_, "-doxorubicin", "doxorubicin")) %>% 
  
  mutate(drug_name_ = case_when(
    str_detect(drug_name_, "kpt") &
      str_detect(drug_name_, "300")            ~ "kpt300",
    str_detect(drug_name_, "kpt") &
      str_detect(drug_name_, "8602")           ~ "kpt8602",
    TRUE                                       ~ drug_name_
  )) %>% 
  
  mutate(drug_name_ = str_replace_all(drug_name_, "cyclophosphomide: dex", "cyclophosphomide; dexamethasone")) %>% 
  filter(!is.na(avatar_id) & drug_name_ != "non-mm drugs") %>% 
  distinct() %>%
  # group_by(avatar_id, drug_start_date) %>%
  # arrange(drug_name_) %>%
  # ungroup() %>%
  arrange(avatar_id, treatment_line_, drug_name_, drug_start_date, drug_stop_date)

# treatment1 <- dcast(setDT(treatment), mrn+avatar_id+treatment_line_+drug_name_ ~ rowid(avatar_id), ## Old code
#                    value.var = c("drug_start_date", "drug_stop_date"))

# Make sure that the same drug in 1 line is counted once with the earliest start date and latest stop date
treatment1 <- treatment %>% group_by(mrn, avatar_id, treatment_line_, drug_name_) %>%
  summarise_at(vars(drug_start_date, drug_stop_date), c(paste), collapse = ";") %>% 
  separate(drug_start_date, "drug_start_date", sep = ";", extra = "drop", fill = "right") %>% 
  separate(drug_stop_date, paste("drug_stop_date", 1:10, sep = ""), sep = ";", remove = FALSE, extra = "warn", fill = "left") %>% 
  select("mrn", "avatar_id", "treatment_line_", "drug_name_", "drug_start_date", drug_stop_date = "drug_stop_date10") %>% 
  group_by(avatar_id, treatment_line_) %>% 
  mutate(line_start_date = min(drug_start_date)) %>% 
  mutate(line_stop_date = max(drug_stop_date))

# Summarize by regimen/line
Treatment1 <- treatment1 %>% 
  group_by(mrn, avatar_id, treatment_line_, line_start_date, line_stop_date) %>%
  arrange(avatar_id, treatment_line_, drug_name_) %>% 
  summarise_at(vars(drug_name_, drug_start_date, drug_stop_date), paste, collapse = "; ") %>%
  mutate(drug_count = sapply(strsplit(drug_name_, ";"), length)) %>% 

# Treatment <- dcast(setDT(treatment1), mrn+avatar_id+treatment_line_ ~ rowid(avatar_id), ## Old code
#                   value.var = c("drug_name_","drug_start_date", "drug_stop_date")) %>% 
#   unite(drug_name_, starts_with("drug_name_"), sep = "; ", na.rm = TRUE, remove = TRUE) %>% 
  
  # unite(drug_start_date, starts_with("drug_start_date"), sep = "; ", na.rm = TRUE, remove = TRUE) %>% 
  # separate(drug_start_date, paste("drug_start_date", 1:max(.$drug_count), sep = ""), sep = "; ", remove = FALSE,
  #          extra = "warn", fill = "right") %>% 
  # mutate(max = max(drug_start_date1:drug_start_date, na.rm = TRUE))
  # 
  # select(c(mrn, avatar_id, treatment_line_, "drug_name_", drug_start_date, ncol(.):drug_stop_date_1)) %>% 
  # unite(drug_stop_date, starts_with("drug_stop_date"), sep = "; ", na.rm = TRUE, remove = TRUE) %>% 
  # separate(drug_stop_date, "drug_stop_date", sep = "; ",
  #          extra = "warn", fill = "right") %>% 
  mutate(line_start_date = as.POSIXct(line_start_date, format = "%Y-%m-%d")) %>% 
  mutate(line_stop_date = as.POSIXct(line_stop_date, format = "%Y-%m-%d")) %>% 
  mutate(regimen_name = case_when(
    drug_count == 7 &
      str_detect(drug_name_, "bort") &
      str_detect(drug_name_, "thalidomide") &
      str_detect(drug_name_, "cyclophosphamide") &
      str_detect(drug_name_, "cisplatin") &
      str_detect(drug_name_, "etoposide") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "doxo")                ~ "VDT-PACE",
    drug_count == 4 &
      str_detect(drug_name_, "bortezomib") &
      str_detect(drug_name_, "cyclophos") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "doxil")               ~ "ABCD",
    drug_count == 4 &
      str_detect(drug_name_, "daratumumab") &
      str_detect(drug_name_, "lena") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "carfilzomib")         ~ "Dara-KRd",
    drug_count == 4 &
      str_detect(drug_name_, "vincristine") &
      str_detect(drug_name_, "cyclophos") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "doxo")                ~ "C-VAD",
    drug_count == 4 &
      str_detect(drug_name_, "thalidomide") &
      str_detect(drug_name_, "vincristine") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "doxil")               ~ "T-VAD doxil",
    drug_count == 4 &
      str_detect(drug_name_, "bortezomib") &
      str_detect(drug_name_, "daratumumab") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "lena")                ~ "D-RVd or dara-RVd",
    drug_count == 4 &
      str_detect(drug_name_, "bortezomib") &
      str_detect(drug_name_, "cyclophosphamide") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "doxo")                ~ "D-RVd or dara-RVd",
    drug_count == 4 &
      str_detect(drug_name_, "bortezomib") &
      str_detect(drug_name_, "cyclophosphamide") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "lena")                ~ "VDCR",
    drug_count == 3 &
      str_detect(drug_name_, "bortezomib") &
      str_detect(drug_name_, "busulfan") &
      str_detect(drug_name_, "melphalan")           ~ "BuMelVel",
    drug_count == 3 &
      str_detect(drug_name_, "cyclophos") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "lena")                ~ "CRd",
    drug_count == 3 &
      str_detect(drug_name_, "cyclophos") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "bort")                ~ "CyBorD or VCd",
    drug_count == 3 &
      str_detect(drug_name_, "doxil") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "lena")                ~ "Dd-R",
    (drug_count == 3 &
       str_detect(drug_name_, "daratu") &
       str_detect(drug_name_, "lena") &
       str_detect(drug_name_, "dex")) |
      str_detect(drug_name_, "ddr")                 ~ "DRd",
    drug_count == 3 &
      str_detect(drug_name_, "vincristine") &
      str_detect(drug_name_, "doxil") &
      str_detect(drug_name_, "dex")                 ~ "DVd",
    drug_count == 3 &
      str_detect(drug_name_, "ixazomib") &
      str_detect(drug_name_, "lena") &
      str_detect(drug_name_, "dex")                 ~ "IRd",
    drug_count == 3 &
      str_detect(drug_name_, "cyclophosphamide") &
      str_detect(drug_name_, "carfilzomib") &
      str_detect(drug_name_, "dex")                 ~ "KCd",
    drug_count == 3 &
      str_detect(drug_name_, "lena") &
      str_detect(drug_name_, "carfilzomib") &
      str_detect(drug_name_, "dex")                 ~ "KRd",
    drug_count == 3 &
      str_detect(drug_name_, "lena") &
      str_detect(drug_name_, "oprozomib") &
      str_detect(drug_name_, "dex")                 ~ "ORd",
    drug_count == 3 &
      str_detect(drug_name_, "bortezomib") &
      str_detect(drug_name_, "doxil") &
      str_detect(drug_name_, "dex")                 ~ "PDd",
    drug_count == 3 &
      str_detect(drug_name_, "bortezomib") &
      str_detect(drug_name_, "doxo") &
      str_detect(drug_name_, "dex")                 ~ "PAd",
    drug_count == 3 &
      str_detect(drug_name_, "lena") &
      str_detect(drug_name_, "doxo") &
      str_detect(drug_name_, "dex")                 ~ "RAd",
    (drug_count == 3 &
       str_detect(drug_name_, "bortezomib") &
       str_detect(drug_name_, "lena") &
       str_detect(drug_name_, "dex")) |
      str_detect(drug_name_, "rvd")                 ~ "VRd", # bmt ctn 0702 (mcc 16529) rvd) # A022592
    drug_count == 3 &
      str_detect(drug_name_, "vincristine") &
      str_detect(drug_name_, "doxo") &
      str_detect(drug_name_, "dex")                 ~ "VAd",
    drug_count == 3 &
      str_detect(drug_name_, "bortezomib") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "melph")               ~ "VMd",
    drug_count == 3 &
      str_detect(drug_name_, "bortezomib") &
      str_detect(drug_name_, "dex") &
      str_detect(drug_name_, "thalidomide")         ~ "VTd",
    drug_count == 2 &
      str_detect(drug_name_, "carfilzomib") &
      str_detect(drug_name_, "dex")                  ~ "Kd",
    drug_count == 2 &
      str_detect(drug_name_, "thal") &
      str_detect(drug_name_, "dex")                  ~ "Td",
    drug_count == 2 &
      str_detect(drug_name_, "lena") &
      str_detect(drug_name_, "dex")                 ~ "Rd",
    drug_count == 2 &
      str_detect(drug_name_, "bortezomib") &
      str_detect(drug_name_, "dex")                 ~ "Bor-Dex",
    drug_count == 1 &
      str_detect(drug_name_, "lenalidomide")        ~ "Lenalidomide",
    drug_count == 1 &
      str_detect(drug_name_, "dex")                 ~ "Dexamethasone",
    drug_count == 1 &
      str_detect(drug_name_, "doxo")                ~ "Doxorubicin",
    drug_count == 1 &
      str_detect(drug_name_, "doxil")               ~ "Doxil",
    drug_count == 1 &
      str_detect(drug_name_, "bortezomib")          ~ "Bortezomib",
    drug_count == 1 &
      str_detect(drug_name_, "melph")               ~ "Melphalan",
    drug_count == 1 &
      str_detect(drug_name_, "carfilzomib")         ~ "Carfilzomib",
    drug_count == 1 &
      str_detect(drug_name_, "cyclo")               ~ "Cyclophosphamide",
    drug_count == 1 &
      str_detect(drug_name_, "thalidomide")         ~ "Thalidomide",
    drug_count == 1 &
      str_detect(drug_name_, "vincristine")         ~ "Vincristine",
    TRUE                                                    ~ drug_name_
  )) %>% 
  mutate(regimen_name = str_replace_na(regimen_name, replacement = "No Drugs"))

# Now can dcast to have line of drug_name_ for each line/regimen ## Old code
# 1st for regimen with same start and end date
# Treatment <- treatment %>% 
#   reshape2::dcast(mrn+avatar_id+treatment_line_+drug_start_date+drug_stop_date ~ rowid(avatar_id),
#                   value.var = c("drug_name_")) %>% 
#   unite(drug_name_, -mrn:-drug_stop_date, sep = "; ", na.rm = TRUE, remove = TRUE) %>% 
#   arrange(drug_start_date, drug_stop_date)
# # 2nd for regimen with same start, I separated it to have the different end date in case
# Treatment <- dcast(setDT(Treatment), mrn+avatar_id+drug_start_date ~ rowid(avatar_id), 
#                    value.var = c("treatment_line_", "drug_name_", "drug_stop_date")) %>%
#   unite(treatment_line_, starts_with("treatment_line_"), sep = "; ", na.rm = TRUE, remove = TRUE) %>%
#   separate(treatment_line_, "treatment_line_", sep = "; ",
#            extra = "warn", fill = "right") %>% 
#   unite(drug_name_, starts_with("drug_name_"), sep = "; ", na.rm = TRUE, remove = TRUE) %>% 
#   unite(drug_stop_date, starts_with("drug_stop_date"), sep = "; ", na.rm = TRUE, remove = TRUE) %>% 
#   separate(drug_stop_date, paste("drug_stop_date", 1:3, sep="_"), sep = "; ",
#            extra = "warn", fill = "right") %>% 
#   arrange(drug_start_date)
# Treatment$drug_stop_date_1 <- as.POSIXct(Treatment$drug_stop_date_1, format = "%Y-%m-%d")
# Treatment$drug_stop_date_2 <- as.POSIXct(Treatment$drug_stop_date_2, format = "%Y-%m-%d")
# Treatment$drug_stop_date_3 <- as.POSIXct(Treatment$drug_stop_date_3, format = "%Y-%m-%d")

# Summarize by avatar_id
Treatment <- dcast(setDT(Treatment1), mrn+avatar_id ~ rowid(avatar_id), 
                   value.var = c("treatment_line_", "line_start_date", "drug_name_", "regimen_name", 
                                 "line_stop_date", "drug_start_date", "drug_stop_date"))

regimen_changed_id <- c("A000180", "A000414", "A014308", "A014310", "A015461", "A022588", "A025760")
Treatment <- Treatment %>% 
  purrr::keep(~!all(is.na(.))) %>% 
  mutate(received_IMIDs = case_when(
    str_detect(drug_name__1, "lidomide") |
      str_detect(drug_name__2, "lidomide") |
      str_detect(drug_name__3, "lidomide") |
      str_detect(drug_name__4, "lidomide") |
      str_detect(drug_name__5, "lidomide") |
      str_detect(drug_name__6, "lidomide") |
      str_detect(drug_name__7, "lidomide") |
      str_detect(drug_name__8, "lidomide") |
      str_detect(drug_name__9, "lidomide") |
      str_detect(drug_name__10, "lidomide") |
      str_detect(drug_name__11, "lidomide") |
      str_detect(drug_name__12, "lidomide") |
      str_detect(drug_name__13, "lidomide") |
      str_detect(drug_name__14, "lidomide") |
      str_detect(drug_name__15, "lidomide")    ~ "IMIDs",
    TRUE ~ "No IMIDs"
  )) %>% 
  full_join(., IMIDS_maintenance, by = "avatar_id") %>% 
  rename(first_regimen_name = regimen_name_1) %>% 
  mutate(first_regimen_name = ifelse((str_detect(avatar_id, paste0(regimen_changed_id, collapse = "|"))), "VRd", first_regimen_name))

colnames(Treatment)
Treatment
```

I cleaned the Treatment data in a lot of different way, this is the last one.  
V1 and V2 has a Qcd_Treatment tab in the data for some patients who were reviewed and qc'd by Raghu. So I first took the IDs in these tab and remove them from the original Treatment tab (which would be less correct).  
Version 1 is "wide" (1 regimen per row but multiple rows per patient) and V2-V4 format is in a long version. So I first bind V1 and Qc'd V1 together, created a treatment_line_ and pivoted longer.  
Qc'd V2 doesn't have `treatment_line_` so Brianna and Nancy checked them and I added them on my file as "First", "Second", etc like it is in V2. After binding V2 and Qc'd V2, I had to pivot longer as one patient was recorded as in V1 format. `r emo::ji("neutral_face")`  
Have one patient like that in V12 too, so do the same `r emo::ji("no_mouth")`  
We are finally ready to bind all versions!!  
The drugs name have some "given with", "investigational agent", "clinical trial" and more. Plus correct some typo in drug names. Plus recode some drug names as "non-MM drugs" to be removed.  
To pivot wider the data, need to do 2 steps: 1- pivot by treatment_line to keep the drugs within the same line together. I created `line_start_date` and `line_stop_date` variables by taking the earliest `drug_start_date` and the latest `drug_stop_date` per line. Code the regimen name. Example if find a line with 2 drug names and find "thal" and "dex", the regimen name is "Td". 2- pivot by patients to have 1 patient by row.  
I had to make sure that a drug name is not repeated in the same line (if start ABC, stop ABC then restart AB then stop = same line) before both step.  
Another thing :  
Ss I said before, I had to remove "given with", "investigational agent", "clinical trial" to code regimen name but we verified some when we found a strange drug date or regimen name (example: I removed "clinical trial:" but not "clinical trial") so we have a lot more we didn't check.
<span style='color: red;'>Should I create that list?</span>

## Radiation
```{r}
RadiationV1$rad_start_date <- as.POSIXct(strptime(RadiationV1$rad_start_date, 
                                                  format = "%m/%d/%Y", tz = "UTC"))
RadiationV1$rad_stop_date <- as.POSIXct(strptime(RadiationV1$rad_stop_date, 
                                                 format = "%m/%d/%Y", tz = "UTC"))

radiation <- bind_rows(Radiation_V12, RadiationV1, RadiationV2, RadiationV4, RadiationV4.1, .id = "versionRad") %>% 
  drop_na("rad_start_date") %>% 
  filter(!str_detect(rad_start_date, "3013")) %>% 
  filter(!str_detect(rad_stop_date, "2300")) %>% 
  distinct(avatar_id, rad_start_date, rad_stop_date, .keep_all = TRUE) %>% 
  arrange(rad_start_date)
Radiation <- dcast(setDT(radiation), avatar_id ~ rowid(avatar_id), value.var = 
                     c("rad_start_date", "rad_stop_date"))
colnames(Radiation)
Radiation
```
Radiation is easy to bind as they are formatted in the same way. 2 patients have strange date in 3013 and 2300.

## Progression
```{r}
Progr_V12 <- Progr_V12 %>% 
  filter(QC == "Yes") %>% 
  drop_na(progression_date) %>% 
  distinct() %>% 
  select(-QC)
uid_P12 <- paste(unique(Progr_V12$avatar_id), collapse = '|')
Progression_V12 <- Progression_V12[(!grepl(uid_P12, Progression_V12$avatar_id)),] %>%  # Remove ID QC'd in Prog_V12
  #Progression_V12 <- Progression_V12 %>% 
  drop_na(progression_date) %>% 
  distinct()

Progression <- 
  bind_rows(Progr_V12, Progression_V12, 
            Progression, ProgressionV2, Progression_V4, Progression_V4.1) %>%
  distinct() %>% drop_na(progression_date) %>% 
  # Taking the dates of progression after the first Dx_date_closest_germline => For OS
  # (either if are MM and progressed or if are MGUS/SM and progressed to MM)
  left_join(., MM_history %>% select(c("avatar_id", "Dx_date_closest_germline")), by = "avatar_id") %>% 
  mutate(prog_after_diag = case_when(
    progression_date <= Dx_date_closest_germline         ~ "removed", # 7 are removed as they become MM
    progression_date > Dx_date_closest_germline          ~ "good" # No NA in date of Dx
  )) %>% 
  filter(prog_after_diag == "good") %>% 
  select(1:2) %>% 
  # Taking only the dates of progression before date_death (it's a sanity check-like)
  left_join(., Vitals %>% select(c("avatar_id", "date_death")), by = "avatar_id") %>% 
  mutate(prog_before_death = case_when(
    progression_date > date_death                 ~ "removed", # 0 patient removed :)
    progression_date < date_death |
      is.na (date_death)                          ~ "good"
  )) %>%
  filter(prog_before_death == "good") %>% 
  select(1:2)

# Create different df for dates from Dx or drug, hct, rad (will not have the same clean up)
Progression_hct <- Progression_rad <- Progression_drugs <- Progression 

Progression <- Progression %>% # Keep earliest progression_date => For OS
  arrange(progression_date) %>% 
  distinct(avatar_id, .keep_all = TRUE)
# write.csv(Progression, paste0(path, "/simplified files/Progression simplify.csv"))

Progression_drugs <- Progression_drugs %>% # Remove progression < drug and keep earliest progression_drug_date
  left_join(., Treatment %>% select(c("avatar_id", "line_start_date_1")), by = "avatar_id") %>% 
  mutate(prog_before_drug = case_when(
    progression_date <= line_start_date_1               ~ "removed", # 0 patient removed :)
    progression_date > line_start_date_1 |
      is.na(line_start_date_1)                          ~ "good" # progression have to be strictly > drug
  )) %>%
  filter(prog_before_drug == "good") %>% 
  select(1:2) %>% 
  arrange(progression_date) %>% 
  distinct(avatar_id, .keep_all = TRUE) %>% 
  rename(progression_drug_date = "progression_date")
# write.csv(Progression_drugs, paste0(path, "/simplified files/Progression used for survivals from drugs date.csv"))

Progression_rad <- Progression_rad %>% # Remove progression < rad and keep earliest progression_rad_date
  left_join(., Radiation %>% select(c("avatar_id", "rad_start_date_1")), by = "avatar_id") %>% 
  mutate(prog_before_rad = case_when(
    progression_date <= rad_start_date_1                ~ "removed", # 93 dates removed
    progression_date > rad_start_date_1 |
      is.na(rad_start_date_1)                           ~ "good" # progression have to be strictly > rad
  )) %>%
  filter(prog_before_rad == "good") %>% 
  select(1:2) %>% 
  arrange(progression_date) %>% 
  distinct(avatar_id, .keep_all = TRUE) %>% 
  rename(progression_rad_date = "progression_date")

Progression_hct <- Progression_hct %>% # Remove progression < hct and keep earliest progression_hct_date
  left_join(., SCT %>% select(c("avatar_id", "date_of_bmt_1")), by = "avatar_id") %>% 
  mutate(prog_before_hct = case_when(
    progression_date <= date_of_bmt_1                  ~ "removed", # 75 dates removed
    progression_date > date_of_bmt_1 |
      is.na(date_of_bmt_1)                             ~ "good" # progression have to be strictly > hct
  )) %>%
  filter(prog_before_hct == "good") %>% 
  select(1:2) %>% 
  arrange(progression_date) %>% 
  distinct(avatar_id, .keep_all = TRUE) %>% 
  rename(progression_hct_date = "progression_date")
```

In V4 legacy, it is 2 way I used to get progression date. In the Treatment_Outcomes tab is `initial_1_pd_date_1` which are non qc'd date, in the "Treatment" tab is `relapse_date` which are qc'd date. In the later it is also a `QC` which says if the dates in `relapse_date` are qc'd. So for legacy, a pre step is to take the date which are qc'd `QC` == "yes' and fill the missing patients with the date from `initial_1_pd_date_1`.
V1 and V2 has `relapse_date` when V4 has `initial_1_pd_date_1`.
All versions are then bound together.  
A first step is then to remove the dates happening before the `Dx_date_closest_germline`. Warning it is not always the first diagnosis date! When I ran that code at the time I removed 7 dates so a later date after `Dx_date_closest_germline` was selected.  
I also have a code to remove any date which would be after death. I kept this code even if didn't remove dates just in case a later version happen to have some.  
Then I sort all dates by increasing order to select the first one happening.
`Progression` have the first date of progression after diagnosis.  
`Progression_drugs` have the first date of progression after `line_start_date_1`.  
`Progression_rad` have the first date of progression after `rad_start_date_1`.  
`Progression_hct` have the first date of progression after `date_of_bmt_1`.
I checked, all patients who received HCT had drugs before.....................

## Prep for the last date available for each patient
```{r Last_labs_dates}
LabsV1 <- gather(LabsV1, key = "event", value = "labs_last_date", 2:ncol(LabsV1)) %>% 
  drop_na(labs_last_date)
LabsV2 <- gather(LabsV2, key = "event", value = "labs_last_date", 2:ncol(LabsV2)) %>% 
  drop_na(labs_last_date)
Labs_V12 <- gather(Labs_V12, key = "event", value = "labs_last_date", 2) %>% 
  drop_na(labs_last_date)
LabsV4 <- gather(LabsV4, key = "event", value = "labs_last_date", 2) %>% 
  drop_na(labs_last_date)
LabsV4.1 <- gather(LabsV4.1, key = "event", value = "labs_last_date", 2) %>% 
  drop_na(labs_last_date)
labs_dates <- bind_rows(LabsV1, LabsV2, Labs_V12, LabsV4, LabsV4.1)
rm(LabsV1, LabsV2, Labs_V12, LabsV4, LabsV4.1)

biopsy <- bind_rows(Biopsy_V12, Biopsy, BiopsyV2, BiopsyV4, BiopsyV4.1) %>% 
  drop_na(biopsy_date) %>% 
  gather(., key = "event", value = "labs_last_date", 2)
imaging <- bind_rows(Imaging, Imaging_V12, ImagingV2, ImagingV4, ImagingV4.1) %>% 
  drop_na() %>% 
  gather(., key = "event", value = "labs_last_date", 2)
metastasis <- bind_rows(Metastasis_V12, MetastasisV4, MetastasisV4.1) %>% 
  drop_na() %>% 
  gather(., key = "event", value = "labs_last_date", 2)
performance <- bind_rows(Performance_V12, PerformanceV2, PerformanceV4, PerformanceV4.1) %>% 
  drop_na() %>% 
  gather(., key = "event", value = "labs_last_date", 2)
staging <- bind_rows(Staging, Staging_V12, StagingV2, StagingV4, StagingV4.1) %>% 
  drop_na() %>% 
  gather(., key = "event", value = "labs_last_date", 2)
tumormarker <- bind_rows(TumorMarker_V12, TumorMarkerV4, TumorMarkerV4.1) %>% 
  drop_na() %>% 
  gather(., key = "event", value = "labs_last_date", 2)
rm(Biopsy_V12, Biopsy, BiopsyV2, BiopsyV4, BiopsyV4.1,
   Imaging, Imaging_V12, ImagingV2, ImagingV4, ImagingV4.1,
   Metastasis_V12, MetastasisV4, MetastasisV4.1,
   Performance_V12, PerformanceV2, PerformanceV4, PerformanceV4.1,
   Staging, Staging_V12, StagingV2, StagingV4, StagingV4.1,
   TumorMarker_V12, TumorMarkerV4, TumorMarkerV4.1)

Last_labs_dates <- bind_rows(labs_dates, biopsy, imaging, metastasis, performance, staging, tumormarker) %>% 
  filter(!str_detect(labs_last_date, "9999|2816|2077")) %>% # Remove mistakes and missing dates
  # remove if its <= to date_of_diagnosis (before MM diagnosis)
  # remove if its => to date_contact_lost 
  left_join(., MM_history %>% select(c("avatar_id", "Dx_date_closest_germline")), by = "avatar_id") %>% 
  # left_join(., Contact_lost %>% select(c("avatar_id", "date_contact_lost")), by = "avatar_id") %>% 
  left_join(., Vitals %>% select(c("avatar_id", "date_contact_lost", "date_last_follow_up")), by = "avatar_id") %>% 
  mutate(labs_before_diag = case_when(
    labs_last_date <= Dx_date_closest_germline             ~ "removed",
    labs_last_date >= date_contact_lost               ~ "removed",
    labs_last_date >= date_last_follow_up             ~ "removed"
  )) %>% 
  filter(is.na(labs_before_diag)) %>% 
  arrange(desc(labs_last_date)) %>% 
  distinct(avatar_id, .keep_all = TRUE)
```

For that I imported all labs, biopsy, imaging, metastasis, performance, staging, tumormarker, bind them, remove the ones before diagnosis and after contact lost or last date of follow up. I then keep the last one happening for each patient as a last lab date.

## Final join
```{r}
patients_removed_nonMM <- c("A000428", "A000456")
Global_data <- full_join(Germline %>%  select(c("avatar_id", "moffitt_sample_id_germline", "SLID_germline",
                             "collectiondt_germline", "Disease_Status_germline", 
                             starts_with("SLID_tumor"), starts_with("collectiondt_tumor_", 
                             starts_with("moffitt_sample_id_tumor")))),
               MM_history, by = "avatar_id") %>% 
  full_join(., Vitals, by = "avatar_id") %>% 
  full_join(., SCT, by = "avatar_id") %>% 
  full_join(., Treatment, by = "avatar_id") %>% 
  full_join(., Radiation, by = "avatar_id") %>% 
  full_join(., Progression, by= "avatar_id") %>% 
  full_join(., Progression_drugs, by= "avatar_id") %>% 
  # full_join(., Progression_treat, by= "avatar_id") %>% 
  full_join(., Progression_rad, by= "avatar_id") %>% 
  full_join(., Progression_hct, by= "avatar_id") %>% 
  full_join(., Last_labs_dates %>% select(c("avatar_id", "labs_last_date")), by = "avatar_id") %>% 
  full_join(., OS_data, by = "avatar_id") %>% 
  full_join(., Staging_ISS, by = c("avatar_id", "collectiondt_germline")) %>% 
  full_join(Demo_RedCap_V4ish %>% select(-TCC_ID), ., by = "avatar_id")
# # write.csv(Global_data, paste0(path, "/Global_data.csv"))
Global_data <- left_join(Global_data, CHIP_status, by = c("SLID_germline" = "patient_germline_id")) %>% 
  filter(!str_detect(avatar_id, paste0(patients_removed_nonMM, collapse = "|")))

colnames(Global_data)
Global_data
```

All the  data produced were set to have one row for each patient as if I had join 1 row of demographic with multiple rows of drugs with multiple row of hct with... I would have have so many repeat of each (drugs for 1 hct as an example).
So here it is easy to bind Germline, MM_history, Vitals, SCT, Treatment, Radiation, Progression, Progression_drugs, Progression_rad, Progression_hct, Last_labs_dates, OS_data, Staging_ISS, Demo_RedCap_V4ish and CHIP_status.  
2 patients , `r patients_removed_nonMM`, are removed from this finale `Global_data` (Raghu said they were mis-classified as MM).

# Creating new variables and create a germline only patient data







